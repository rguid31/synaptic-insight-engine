<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synaptic Insight Engine</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <style>
        /* --- Base & Typography --- */
        :root {
            --glow-color: #00ff88;
            --primary-text: #e0e0e0;
            --secondary-text: #888;
            --bg-dark: #0a0a0a;
            --surface-color: rgba(20, 20, 30, 0.9);
            --border-color: rgba(100, 100, 255, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--primary-text);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* --- Background Effect --- */
        .neural-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0.15;
            background: 
                radial-gradient(circle at 20% 50%, #00ff8840 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, #ff00ff40 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, #00ffff40 0%, transparent 50%);
            animation: pulse 10s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.15; }
            50% { opacity: 0.25; }
        }

        /* --- Layout & Containers --- */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        header {
            background: linear-gradient(135deg, rgba(20, 20, 30, 0.95), rgba(30, 20, 40, 0.95));
            border: 1px solid var(--border-color);
            border-radius: 25px;
            padding: 40px;
            margin-bottom: 30px;
            backdrop-filter: blur(20px);
            box-shadow: 0 0 40px rgba(100, 100, 255, 0.2), inset 0 0 20px rgba(100, 100, 255, 0.1);
            position: relative;
            overflow: hidden;
            text-align: center; /* Centered header text */
        }

        header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(100, 100, 255, 0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00ff88, #00ffff, #ff00ff);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            position: relative;
            z-index: 1;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .subtitle {
            color: var(--secondary-text);
            font-size: 1.1em;
            position: relative;
            z-index: 1;
        }

        /* --- Input Section --- */
        .input-section {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .url-input {
            width: 100%;
            padding: 15px 20px;
            background: rgba(10, 10, 20, 0.8);
            border: 2px solid var(--border-color);
            border-radius: 15px;
            color: var(--primary-text);
            font-size: 1.1em;
            margin-bottom: 25px;
            transition: all 0.3s ease;
        }

        .url-input:focus {
            outline: none;
            border-color: var(--glow-color);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        .features-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .features-column h3 {
            font-size: 1.1em;
            color: var(--primary-text);
            margin-bottom: 15px;
            /* Key fix for icon alignment */
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .features-column ul {
            list-style: none;
            color: var(--secondary-text);
            padding-left: 10px; /* Align with title */
        }

        .features-column ul li {
            margin-bottom: 8px;
            position: relative;
            padding-left: 25px;
        }

        .features-column ul li::before {
            content: '•';
            color: var(--glow-color);
            position: absolute;
            left: 0;
            font-size: 1.2em;
            line-height: 1;
        }
        
        .button-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .analyze-btn, .random-btn, .reset-btn {
            color: #000;
            border: none;
            padding: 15px 0;
            width: 300px;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .analyze-btn:active, .random-btn:active, .reset-btn:active {
            transform: scale(0.98);
        }

        .random-btn { background: #444; color: #fff; }
        .analyze-btn { background: linear-gradient(135deg, var(--glow-color), #00ffff); }
        .reset-btn { background: #600; color: #fff; display: none; }


        /* --- Carousel Section --- */
        .category-section {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .category-title {
            font-size: 1.3em;
            margin-bottom: 20px;
            color: var(--primary-text);
            text-align: center;
        }

        .carousel-container {
            position: relative;
            padding: 0 40px; /* Key fix for arrow visibility */
        }
        
        .carousel-pages {
            display: flex;
            transition: transform 0.5s ease-in-out;
            gap: 5%; /* Spacing between pages */
        }
        
        .carousel-page {
            flex: 0 0 100%;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            padding: 10px 0; /* Vertical padding for hover effect space */
        }

        .category-btn {
            background: linear-gradient(135deg, rgba(100, 100, 255, 0.1), rgba(100, 100, 255, 0.2));
            border: 2px solid transparent;
            border-radius: 15px;
            padding: 15px;
            color: var(--primary-text);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 0.9em;
        }

        .category-btn:hover {
            transform: translateY(-3px);
            border-color: var(--glow-color);
            box-shadow: 0 5px 20px rgba(0, 255, 136, 0.3);
        }
        
        .category-icon { font-size: 1.5em; display: block; margin-bottom: 8px; }

        .carousel-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        .carousel-nav.prev { left: -10px; }
        .carousel-nav.next { right: -10px; }
        .carousel-nav svg {
            width: 20px;
            height: 20px;
            color: var(--primary-text);
        }
        
        .carousel-indicators {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .indicator {
            width: 10px;
            height: 10px;
            background: var(--border-color);
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.3s;
        }
        .indicator.active { background: var(--glow-color); }

        /* --- Results & Blueprint Sections --- */
        .analysis-results {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .source-text-section, .blueprint-section {
            display: none;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 30px;
            margin-top: 30px;
            backdrop-filter: blur(10px);
        }
        
        .section-title {
            font-size: 1.8em;
            margin-bottom: 20px;
            color: var(--glow-color);
        }

        .result-card, .source-text-content, .blueprint-content {
            background: rgba(10, 10, 20, 0.8);
            border-radius: 15px;
            padding: 20px;
            font-size: 0.9em;
            line-height: 1.6;
            white-space: pre-wrap; /* Ensures blueprint formatting is kept */
            overflow-x: auto; /* For long lines in code/text */
        }
        
        .result-card { padding: 25px; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .card-title { font-size: 1.3em; margin-bottom: 15px; color: var(--glow-color); display: flex; align-items: center; gap: 10px; }
        .card-icon { width: 30px; height: 30px; background: linear-gradient(135deg, var(--glow-color), #00ffff); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2em; color: #000; }

        .exploit-item, .opportunity-item, .gap-item, .model-item { padding: 10px 15px; margin: 10px 0; border-radius: 5px; font-size: 0.95em; }
        .exploit-item { background: rgba(255, 0, 100, 0.1); border-left: 3px solid #ff0064; }
        .opportunity-item { background: rgba(0, 255, 136, 0.1); border-left: 3px solid var(--glow-color); }
        .gap-item { background: rgba(255, 165, 0, 0.1); border-left: 3px solid orange; }
        .model-item { background: rgba(0, 206, 209, 0.1); border-left: 3px solid darkturquoise; }

        /* --- Loading, Toasts & Other UI --- */
        .loading { display: none; text-align: center; padding: 40px; }
        .neural-loader { width: 80px; height: 80px; margin: 0 auto 20px; border: 3px solid var(--border-color); border-top: 3px solid var(--glow-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 15px 25px; border-radius: 50px; z-index: 1000; opacity: 0; transition: opacity 0.3s, bottom 0.3s; }
        .toast.show { opacity: 1; bottom: 40px; }
        .toast.error { background: #800; }
        
        .context-link { color: var(--glow-color); text-decoration: none; font-size: 0.8em; margin-left: 5px; }
        mark.flash-highlight { background-color: var(--glow-color); color: #000; animation: flash 2s; }
        @keyframes flash { 50% { background-color: inherit; color: inherit; } }

        /* --- Footer --- */
        footer {
            text-align: center;
            padding: 40px 20px;
            color: var(--secondary-text);
            font-size: 0.9em;
        }
        .footer-icons { margin-top: 15px; display: flex; justify-content: center; gap: 20px; }
        .footer-icons a { color: var(--secondary-text); transition: color 0.3s; }
        .footer-icons a:hover { color: var(--glow-color); }
        .footer-icons svg { width: 24px; height: 24px; }
        
        /* --- Responsive Design --- */
        @media (max-width: 768px) {
            h1 { font-size: 2em; }
            .features-grid { grid-template-columns: 1fr; }
            .features-column { justify-content: flex-start; } /* Align left on mobile */
            .carousel-page { grid-template-columns: repeat(2, 1fr); }
            .carousel-container { padding: 0 30px; }
            .carousel-nav.prev { left: -15px; }
            .carousel-nav.next { right: -15px; }
        }

    </style>
</head>
<body>
    <div class="neural-bg"></div>
    
    <div class="container">
        <header>
            <h1>Synaptic Insight Engine</h1>
            <p class="subtitle">Extract Exploits → Identify Gaps → Generate Blueprints → Build MVPs</p>
        </header>

        <div class="input-section">
            <form id="analyzeForm">
                <input type="url" class="url-input" id="urlInput" placeholder="Enter case study URL (e.g., https://arxiv.org/abs/1234.56789)" aria-label="Case Study URL Input" required>
                <div class="features-grid">
                    <div class="features-column">
                        <div>
                            <h3><span class="card-icon" style="font-size: 0.8em; width: 24px; height: 24px;">🔬</span> Standard Analysis</h3>
                            <ul>
                                <li>Unscientific claims & money-making tactics</li>
                                <li>Knowledge gaps & missing data</li>
                                <li>Opportunities for legitimate solutions</li>
                                <li>Growth mechanics based on mathematical models</li>
                            </ul>
                        </div>
                    </div>
                    <div class="features-column">
                        <div>
                            <h3><span class="card-icon" style="font-size: 0.8em; width: 24px; height: 24px;">��</span> Premium Analysis</h3>
                            <ul>
                                <li>Market viability scoring</li>
                                <li>Suggested MVP feature set</li>
                                <li>Potential funding avenues</li>
                                <li>Ethical consideration flags</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="button-container">
                    <button type="button" class="random-btn" onclick="loadRandomExample()" aria-label="Load a random example URL">🎲 Try a Random Example</button>
                    <button type="submit" class="analyze-btn" aria-label="Analyze the provided case study URL">�� Analyze Case Study</button>
                    <button type="button" class="reset-btn" onclick="resetUI()" aria-label="Reset the analysis fields">🔄 Reset</button>
                </div>
            </form>
            <div id="error" style="color: red; text-align: center; margin-top: 15px;"></div>
        </div>

        <div class="category-section" id="domainCarousel">
            <h2 class="category-title">Or, Select a Research Domain to Find a Case Study</h2>
            <div class="carousel-container">
                <div class="carousel-pages" id="carouselPages">
                    <!-- Carousel pages will be generated by JavaScript -->
                </div>
                <!-- Key fix for arrows - replaced characters with SVG -->
                <div class="carousel-nav prev" onclick="prevCarouselPage()" aria-label="Previous page of research domains">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                </div>
                <div class="carousel-nav next" onclick="nextCarouselPage()" aria-label="Next page of research domains">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </div>
            </div>
            <div class="carousel-indicators" id="carouselIndicators">
                <!-- Indicators will be generated by JavaScript -->
            </div>
        </div>
        
        <div class="loading">
            <div class="neural-loader"></div>
            <p id="loadingText">Processing neural pathways...</p>
        </div>
        
        <div class="analysis-results" id="results"></div>

        <div class="source-text-section" id="sourceTextSection">
            <h2 class="section-title">📝 Analyzed Source Text</h2>
            <div class="source-text-content" id="sourceTextContent"></div>
        </div>

        <div class="blueprint-section" id="blueprintSection">
            <h2 class="section-title">📋 Generated Blueprint</h2>
            <div class="blueprint-content" id="blueprintContent"></div>
            <button class="random-btn" onclick="downloadBlueprint()" aria-label="Download the generated blueprint as a text file" style="background: #334;">⬇ Download Blueprint</button>
        </div>
    </div>
    
    <footer>
        <p>Created by Ryan Guidry 🦄 <a href="https://rguidry.dev" target="_blank" rel="noopener noreferrer">rguidry.dev</a></p>
        <div class="footer-icons">
            <a href="https://linkedin.com/in/rmguidry" target="_blank" rel="noopener noreferrer" aria-label="Ryan Guidry's LinkedIn Profile">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
            </a>
            <a href="https://github.com/rguid31" target="_blank" rel="noopener noreferrer" aria-label="Ryan Guidry's GitHub Profile">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
            </a>
        </div>
    </footer>

    <script>
        // --- DOM ELEMENTS ---
        const urlInput = document.getElementById('urlInput');
        const analyzeForm = document.getElementById('analyzeForm');
        const errorDiv = document.getElementById('error');
        const resultsDiv = document.getElementById('results');
        const loadingDiv = document.querySelector('.loading');
        const blueprintSection = document.getElementById('blueprintSection');
        const blueprintContent = document.getElementById('blueprintContent');
        const sourceTextSection = document.getElementById('sourceTextSection');
        const sourceTextContent = document.getElementById('sourceTextContent');
        const carouselPagesContainer = document.getElementById('carouselPages');
        const carouselIndicators = document.getElementById('carouselIndicators');

        // --- GLOBAL STATE ---
        let currentAnalysisResult = null;
        let currentPage = 0;

        // --- DOMAINS & CAROUSEL SETUP ---
        const domains = [
            { name: "AI/ML", icon: "🤖", url: "https://arxiv.org/list/cs.AI/recent" },
            { name: "AI in Drug Discovery", icon: "💊", url: "https://scholar.google.com/scholar?q=AI+in+drug+discovery" },
            { name: "Biotechnology", icon: "🧬", url: "https://arxiv.org/list/q-bio.BM/recent" },
            { name: "Data Science", icon: "📊", url: "https://arxiv.org/list/cs.DB/recent" },
            { name: "Personalized Med", icon: "🩺", url: "https://scholar.google.com/scholar?q=personalized+medicine" },
            { name: "Cybersecurity", icon: "🛡️", url: "https://arxiv.org/list/cs.CR/recent" },
            { name: "Climate Mitigation", icon: "🌍", url: "https://scholar.google.com/scholar?q=climate+change+mitigation" },
            { name: "Sustainable Agri", icon: "🌾", url: "https://scholar.google.com/scholar?q=sustainable+agriculture" },
            { name: "Quantum Computing", icon: "🌀", url: "https://arxiv.org/list/quant-ph/recent" },
            { name: "Neurodegenerative", icon: "🧠", url: "https://scholar.google.com/scholar?q=neurodegenerative+disease+research" },
            { name: "Blockchain", icon: "🔗", url: "https://scholar.google.com/scholar?q=blockchain+technology" },
            { name: "Waste Management", icon: "♻️", url: "https://scholar.google.com/scholar?q=waste+management+circular+economy" },
            { name: "Space Exploration", icon: "🚀", url: "https://arxiv.org/list/astro-ph/recent" },
            { name: "Advanced Materials", icon: "🔩", url: "https://scholar.google.com/scholar?q=advanced+materials+research" },
            { name: "Robotics & Automation", icon: "🤖", url: "https://arxiv.org/list/cs.RO/recent" },
            { name: "Bioinformatics", icon: "💻", url: "https://scholar.google.com/scholar?q=bioinformatics" },
            { name: "Renewable Energy", icon: "☀️", url: "https://scholar.google.com/scholar?q=renewable+energy+technology" },
            { name: "Mental Health Research", icon: "🧘", url: "https://scholar.google.com/scholar?q=mental+health+research" },
            { name: "Ecosystem Conservation", icon: "🌳", url: "https://scholar.google.com/scholar?q=ecosystem+conservation" },
            { name: "Sociology", icon: "👥", url: "https://scholar.google.com/scholar?q=sociology+research" },
            { name: "Business/Economics", icon: "📈", url: "https://arxiv.org/list/econ.GN/recent" },
            { name: "Physics", icon: "⚛️", url: "https://arxiv.org/list/physics/recent" },
            { name: "AI Engineering", icon: "⚙️", url: "https://scholar.google.com/scholar?q=AI+engineering" },
            { name: "Nanotechnology", icon: "🔬", url: "https://scholar.google.com/scholar?q=nanotechnology" }
        ];

        const totalPages = Math.ceil(domains.length / 8);

        function setupCarousel() {
            carouselPagesContainer.innerHTML = '';
            carouselIndicators.innerHTML = '';

            for (let i = 0; i < totalPages; i++) {
                const page = document.createElement('div');
                page.className = 'carousel-page';
                if (i === 0) page.classList.add('active');

                const pageDomains = domains.slice(i * 8, (i + 1) * 8);
                pageDomains.forEach((domain, index) => {
                    const domainIndex = i * 8 + index;
                    page.innerHTML += `
                        <div class="category-btn" onclick="window.open('${domain.url}', '_blank')" aria-label="Find case studies in ${domain.name}">
                            <span class="category-icon">${domain.icon}</span>
                            ${domainIndex + 1}. ${domain.name}
                        </div>
                    `;
                });
                carouselPagesContainer.appendChild(page);

                const indicator = document.createElement('div');
                indicator.className = 'indicator';
                if (i === 0) indicator.classList.add('active');
                indicator.onclick = () => goToPage(i);
                carouselIndicators.appendChild(indicator);
            }
        }

        function updateCarousel() {
            const offset = -currentPage * (100 + 5);
            carouselPagesContainer.style.transform = `translateX(${offset}%)`;
            document.querySelectorAll('.indicator').forEach((ind, i) => ind.classList.toggle('active', i === currentPage));
        }

        function nextCarouselPage() {
            currentPage = (currentPage + 1) % totalPages;
            updateCarousel();
        }

        function prevCarouselPage() {
            currentPage = (currentPage - 1 + totalPages) % totalPages;
            updateCarousel();
        }

        function goToPage(pageNumber) {
            currentPage = pageNumber;
            updateCarousel();
        }

        // --- CORE APPLICATION LOGIC ---
        async function analyzeCase() {
            const url = urlInput.value.trim();
            if (!url) {
                showToast('Please enter a valid URL', true);
                errorDiv.textContent = 'Please enter a valid URL';
                return;
            }

            resetUI(true);
            updateLoadingText('Processing neural pathways...');
            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(`HTTP error! Status: ${response.status}, Body: ${text}`);
                }
                const data = await response.json();
                currentAnalysisResult = data;
                displayResults(data.analysis);
                displaySourceText(data.sourceText);
                generateBlueprint();
                showToast('Analysis complete!');
            } catch (error) {
                console.error('Error during analysis:', error);
                showToast(error.message, true);
                errorDiv.textContent = error.message;
            } finally {
                loadingDiv.style.display = 'none';
            }
        }

        function displayResults(analysis) {
            resultsDiv.innerHTML = '';
            const categories = {
                exploits: { title: "Exploits & Red Flags", icon: "🚩", class: "exploit-item" },
                opportunities: { title: "Opportunities & Core Tech", icon: "💡", class: "opportunity-item" },
                gaps: { title: "Knowledge Gaps", icon: "❓", class: "gap-item" },
                models: { title: "Growth Models", icon: "📈", class: "model-item" }
            };

            for (const key in categories) {
                const category = categories[key];
                const items = analysis[key] || [];
                let itemsHtml = items.length > 0
                    ? items.map(item => `<div class="${category.class}">${highlightTextInString(item)}</div>`).join('')
                    : `<p>No significant items found.</p>`;

                const cardHtml = `
                    <div class="result-card">
                        <h3 class="card-title"><span class="card-icon">${category.icon}</span> ${category.title}</h3>
                        ${itemsHtml}
                    </div>
                `;
                resultsDiv.innerHTML += cardHtml;
            }
            resultsDiv.style.display = 'grid';
            document.querySelector('.reset-btn').style.display = 'flex';
        }

        function displaySourceText(text) {
            sourceTextContent.textContent = text;
            sourceTextSection.style.display = 'block';
        }

        // --- UTILITY & HELPER FUNCTIONS ---
        function showToast(message, isError = false) {
            const toast = document.createElement('div');
            toast.className = `toast ${isError ? 'error' : ''}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => { toast.classList.add('show'); }, 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 4000);
        }

        function updateLoadingText(text) {
            document.getElementById('loadingText').textContent = text;
        }

        function resetUI(isLoading = false) {
            resultsDiv.style.display = 'none';
            blueprintSection.style.display = 'none';
            sourceTextSection.style.display = 'none';
            errorDiv.textContent = '';
            loadingDiv.style.display = isLoading ? 'block' : 'none';
            if (!isLoading) {
                urlInput.value = '';
                document.querySelector('.reset-btn').style.display = 'none';
                currentAnalysisResult = null;
            }
        }

        function loadRandomExample() {
            const examples = [
                { url: 'https://arxiv.org/html/2307.12008v2' },
                { url: 'https://www.nature.com/articles/s41586-023-06189-9' },
                { url: 'https://www.science.org/doi/10.1126/science.adi0517' }
            ];
            const randomExample = examples[Math.floor(Math.random() * examples.length)];
            urlInput.value = randomExample.url;
            showToast('Random example URL loaded. Click "Analyze" to proceed.');
        }

        function highlightTextInString(text) {
            if (!currentAnalysisResult || !currentAnalysisResult.sourceText) return text;
            const keywords = text.match(/"(.*?)"/g);
            if (!keywords) return text;

            const keyword = keywords[0].replace(/"/g, '');
            return `${text} <a href="#sourceTextSection" onclick="event.preventDefault(); scrollToHighlight('${keyword.replace(/'/g, "\\'")}')" class="context-link">(See context)</a>`;
        }

        function scrollToHighlight(keyword) {
            const contentEl = sourceTextContent;
            const originalText = contentEl.textContent;
            const regex = new RegExp(keyword.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'gi');

            contentEl.innerHTML = originalText.replace(regex, `<mark class="flash-highlight">$&</mark>`);
            
            const mark = contentEl.querySelector('mark');
            if (mark) {
                mark.scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(() => { contentEl.textContent = originalText; }, 2000);
            } else {
                contentEl.textContent = originalText;
            }
        }

        function generateBlueprint() {
            if (!currentAnalysisResult) return;
            const { analysis } = currentAnalysisResult;
            const opportunities = analysis.opportunities || [];
            const gaps = analysis.gaps || [];

            let blueprintText = `
Project Blueprint: A Legitimate MVP Approach
============================================

Based on the analysis, here is a potential roadmap to build a Minimum Viable Product (MVP) that addresses the identified gaps and leverages the core opportunities.

1. Core Problem to Solve:
-------------------------
Address the primary knowledge gap: "${gaps.length > 0 ? gaps[0].split('"')[1] || 'Lack of verifiable data' : 'Lack of verifiable data'}".

2. Key Technology/Principle to Use:
-----------------------------------
Focus on the core legitimate opportunity: "${opportunities.length > 0 ? opportunities[0].split('"')[1] || 'The underlying scientific principle' : 'The underlying scientific principle'}".

3. Proposed MVP Features:
------------------------
* A public data dashboard to transparently display experimental results.
* An open-source simulation model of the core scientific mechanism.
* A peer-review submission portal to gather external validation.
* Clear, documented methodology for replication.

4. Key Metrics for Success:
---------------------------
* Number of successful, independent replications of the core result.
* Correlation factor between simulation and real-world experimental data.
* Number of positive peer reviews received through the portal.
            `;
            blueprintContent.textContent = blueprintText.trim();
            blueprintSection.style.display = 'block';
            blueprintSection.scrollIntoView({ behavior: 'smooth' });
        }

        function downloadBlueprint() {
            if (!blueprintContent.textContent) {
                showToast('No blueprint to download.', true);
                return;
            }
            const blob = new Blob([blueprintContent.textContent], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'mvp-blueprint.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Form submission handler
        analyzeForm.addEventListener('submit', (e) => {
            e.preventDefault();
            analyzeCase();
        });

        document.addEventListener('DOMContentLoaded', () => {
            setupCarousel();
        });
    </script>
</body>
</html>

