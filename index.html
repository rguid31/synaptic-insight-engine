<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synaptic Insight Engine</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <style>
        /* --- Base & Typography --- */
        :root {
            --glow-color: #00ff88;
            --primary-text: #e0e0e0;
            --secondary-text: #888;
            --bg-dark: #0a0a0a;
            --surface-color: rgba(20, 20, 30, 0.9);
            --border-color: rgba(100, 100, 255, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--primary-text);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* --- Background Effect --- */
        .neural-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0.15;
            background: 
                radial-gradient(circle at 20% 50%, #00ff8840 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, #ff00ff40 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, #00ffff40 0%, transparent 50%);
            animation: pulse 10s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.15; }
            50% { opacity: 0.25; }
        }

        /* --- Layout & Containers --- */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
            /* Allow content to extend outside container if needed */
            overflow: visible;
        }

        header {
            background: linear-gradient(135deg, rgba(20, 20, 30, 0.95), rgba(30, 20, 40, 0.95));
            border: 1px solid var(--border-color);
            border-radius: 25px;
            padding: 40px;
            margin-bottom: 30px;
            backdrop-filter: blur(20px);
            box-shadow: 0 0 40px rgba(100, 100, 255, 0.2), inset 0 0 20px rgba(100, 100, 255, 0.1);
            position: relative;
            overflow: visible; /* Allow dropdown to extend outside header */
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            position: relative;
            z-index: 1;
        }

        .header-main {
            flex: 1;
            text-align: center;
        }

        .header-auth {
            flex: 0 0 auto;
            display: flex;
            justify-content: flex-end;
            min-width: 200px;
        }

        header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(100, 100, 255, 0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00ff88, #00ffff, #ff00ff);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            position: relative;
            z-index: 1;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .subtitle {
            color: var(--secondary-text);
            font-size: 1.1em;
            position: relative;
            z-index: 1;
        }

        /* --- Input Section --- */
        .input-section {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .url-input {
            width: 100%;
            padding: 15px 20px;
            background: rgba(10, 10, 20, 0.8);
            border: 2px solid var(--border-color);
            border-radius: 15px;
            color: var(--primary-text);
            font-size: 1.1em;
            margin-bottom: 25px;
            transition: all 0.3s ease;
        }

        .url-input:focus {
            outline: none;
            border-color: var(--glow-color);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        .features-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .features-column h3 {
            font-size: 1.1em;
            color: var(--primary-text);
            margin-bottom: 15px;
            /* Key fix for icon alignment */
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .features-column ul {
            list-style: none;
            color: var(--secondary-text);
            padding-left: 10px; /* Align with title */
        }

        .features-column ul li {
            margin-bottom: 8px;
            position: relative;
            padding-left: 25px;
        }

        .features-column ul li::before {
            content: '•';
            color: var(--glow-color);
            position: absolute;
            left: 0;
            font-size: 1.2em;
            line-height: 1;
        }
        
        .button-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .analyze-btn, .random-btn, .reset-btn, .bookmark-btn {
            color: #000;
            border: none;
            padding: 15px 0;
            width: 300px;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .analyze-btn:active, .random-btn:active, .reset-btn:active, .bookmark-btn:active {
            transform: scale(0.98);
        }

        .random-btn { background: #444; color: #fff; }
        .analyze-btn { background: linear-gradient(135deg, var(--glow-color), #00ffff); }
        .reset-btn { background: #600; color: #fff; display: none; }
        .bookmark-btn { background: linear-gradient(135deg, #ffaa00, #ff8800); color: #fff; display: none; }


        /* --- Carousel Section --- */
        .category-section {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .category-title {
            font-size: 1.3em;
            margin-bottom: 20px;
            color: var(--primary-text);
            text-align: center;
        }

        .carousel-container {
            position: relative;
            padding: 0 40px; /* Key fix for arrow visibility */
        }
        
        .carousel-pages {
            display: flex;
            transition: transform 0.5s ease-in-out;
            gap: 5%; /* Spacing between pages */
        }
        
        .carousel-page {
            flex: 0 0 100%;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            padding: 10px 0; /* Vertical padding for hover effect space */
        }

        .category-btn {
            background: linear-gradient(135deg, rgba(100, 100, 255, 0.1), rgba(100, 100, 255, 0.2));
            border: 2px solid transparent;
            border-radius: 15px;
            padding: 15px;
            color: var(--primary-text);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 0.9em;
        }

        .category-btn:hover {
            transform: translateY(-3px);
            border-color: var(--glow-color);
            box-shadow: 0 5px 20px rgba(0, 255, 136, 0.3);
        }
        
        .category-icon { font-size: 1.5em; display: block; margin-bottom: 8px; }

        .carousel-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        .carousel-nav.prev { left: -10px; }
        .carousel-nav.next { right: -10px; }
        .carousel-nav svg {
            width: 20px;
            height: 20px;
            color: var(--primary-text);
        }
        
        .carousel-indicators {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .indicator {
            width: 10px;
            height: 10px;
            background: var(--border-color);
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.3s;
        }
        .indicator.active { background: var(--glow-color); }

        /* --- Results & Blueprint Sections --- */
        .analysis-results {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .source-text-section, .blueprint-section {
            display: none;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 30px;
            margin-top: 30px;
            backdrop-filter: blur(10px);
        }

        .dropdown-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .dropdown-arrow {
            font-size: 1.2em;
            color: var(--glow-color);
            transition: transform 0.3s ease;
            user-select: none;
        }

        .dropdown-arrow.expanded {
            transform: rotate(180deg);
        }

        .source-text-content.collapsed {
            display: none;
        }

        .source-text-content.expanded {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; max-height: 0; }
            to { opacity: 1; max-height: 1000px; }
        }

        /* JSON Structured Data Styling */
        .structured-data {
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
        }

        .json-section {
            background: rgba(0, 20, 40, 0.6);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .json-section-title {
            background: linear-gradient(135deg, var(--glow-color), #00ffff);
            color: #000;
            font-weight: bold;
            font-size: 1.1em;
            padding: 12px 20px;
            text-transform: capitalize;
            letter-spacing: 1px;
        }

        .json-section-content {
            padding: 20px;
            color: var(--primary-text);
            line-height: 1.6;
        }

        .json-section-content p {
            margin: 0;
            color: #e0e0e0;
        }

        .json-section-content ul {
            margin: 10px 0;
            padding-left: 20px;
            list-style: none;
        }

        .json-section-content ul li {
            margin-bottom: 8px;
            position: relative;
            color: #c0c0c0;
            padding-left: 20px;
        }

        .json-section-content ul li::before {
            content: '▸';
            color: var(--glow-color);
            position: absolute;
            left: 0;
            font-size: 1.1em;
        }

        .json-object {
            background: rgba(10, 10, 30, 0.5);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .json-key-value {
            margin: 10px 0;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .json-key {
            color: var(--glow-color);
            font-weight: bold;
            min-width: 100px;
        }

        .json-value {
            color: #ffffff;
            flex: 1;
        }
        
        .section-title {
            font-size: 1.8em;
            margin-bottom: 20px;
            color: var(--glow-color);
        }

        .result-card, .source-text-content, .blueprint-content {
            background: rgba(10, 10, 20, 0.8);
            border-radius: 15px;
            padding: 20px;
            font-size: 0.9em;
            line-height: 1.6;
            white-space: pre-wrap; /* Ensures blueprint formatting is kept */
            overflow-x: auto; /* For long lines in code/text */
        }
        
        .result-card { padding: 25px; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .card-title { font-size: 1.3em; margin-bottom: 15px; color: var(--glow-color); display: flex; align-items: center; gap: 10px; }
        .card-icon { width: 30px; height: 30px; background: linear-gradient(135deg, var(--glow-color), #00ffff); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2em; color: #000; }

        .exploit-item, .opportunity-item, .gap-item, .model-item, .ethical-item, .reproducibility-item {
            padding: 10px 15px; margin: 10px 0; border-radius: 5px; font-size: 0.95em; line-height: 1.5;
        }
        .exploit-item { background: rgba(255, 0, 100, 0.1); border-left: 3px solid #ff0064; }
        .opportunity-item { background: rgba(0, 255, 136, 0.1); border-left: 3px solid var(--glow-color); }
        .gap-item { background: rgba(255, 165, 0, 0.1); border-left: 3px solid orange; }
        .model-item { background: rgba(0, 206, 209, 0.1); border-left: 3px solid darkturquoise; }
        .ethical-item { background: rgba(186, 85, 211, 0.1); border-left: 3px solid #BA55D3; }
        .reproducibility-item { background: rgba(34, 139, 34, 0.1); border-left: 3px solid #228B22; }

        /* Ranked Item Styling */
        .ranked-item {
            margin-bottom: 8px;
        }

        .item-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
            flex-wrap: wrap;
        }

        .rank-badge {
            background: linear-gradient(135deg, var(--glow-color), #00ffff);
            color: #000;
            font-weight: bold;
            font-size: 0.8em;
            padding: 4px 8px;
            border-radius: 12px;
            min-width: 35px;
            text-align: center;
        }

        .rank-1 { background: linear-gradient(135deg, #ff4444, #ff6666); color: #fff; }
        .rank-2 { background: linear-gradient(135deg, #ff8800, #ffaa33); color: #fff; }
        .rank-3 { background: linear-gradient(135deg, #ffcc00, #ffdd44); color: #000; }
        .rank-4 { background: linear-gradient(135deg, #88cc88, #aaddaa); color: #000; }
        .rank-5 { background: linear-gradient(135deg, #cccccc, #dddddd); color: #000; }

        .status-badge {
            font-weight: bold;
            font-size: 0.7em;
            padding: 4px 10px;
            border-radius: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-critical { background: #ff0000; color: #fff; animation: pulse-red 2s infinite; }
        .status-high { background: #ff6600; color: #fff; }
        .status-moderate { background: #ffaa00; color: #000; }
        .status-low { background: #00aa00; color: #fff; }

        @keyframes pulse-red {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .confidence-badge {
            font-weight: bold;
            font-size: 0.7em;
            padding: 4px 10px;
            border-radius: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: 1px solid;
        }

        .confidence-very-high {
            background: rgba(0, 255, 0, 0.2);
            color: #00ff00;
            border-color: #00ff00;
        }

        .confidence-high {
            background: rgba(0, 200, 100, 0.2);
            color: #00c864;
            border-color: #00c864;
        }

        .confidence-medium {
            background: rgba(255, 200, 0, 0.2);
            color: #ffc800;
            border-color: #ffc800;
        }

        .confidence-low {
            background: rgba(255, 150, 0, 0.2);
            color: #ff9600;
            border-color: #ff9600;
        }

        .confidence-very-low {
            background: rgba(255, 50, 50, 0.2);
            color: #ff3232;
            border-color: #ff3232;
        }

        .tags-container {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .tag-badge {
            background: rgba(100, 100, 255, 0.2);
            color: var(--primary-text);
            font-size: 0.7em;
            padding: 3px 8px;
            border-radius: 10px;
            border: 1px solid rgba(100, 100, 255, 0.3);
        }

        .item-content {
            padding-left: 5px;
            border-left: 2px solid rgba(100, 100, 255, 0.2);
            margin-left: 20px;
        }

        /* Research Score Chart Styling */
        .research-score-section {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 30px;
            margin-top: 30px;
            backdrop-filter: blur(10px);
        }

        .score-title {
            font-size: 1.5em;
            color: var(--glow-color);
            margin-bottom: 25px;
            text-align: center;
        }

        .score-chart {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 30px;
            align-items: center;
            margin-bottom: 30px;
        }

        .overall-score {
            display: flex;
            justify-content: center;
        }

        .overall-score-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 4px solid;
            position: relative;
        }

        .score-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #fff;
        }

        .score-label {
            font-size: 0.9em;
            color: #ccc;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .detailed-scores {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .score-metric {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .metric-label {
            min-width: 140px;
            font-size: 0.9em;
            color: var(--primary-text);
            font-weight: 500;
        }

        .metric-bar {
            flex: 1;
            height: 25px;
            background: rgba(50, 50, 70, 0.5);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }

        .metric-fill {
            height: 100%;
            border-radius: 12px;
            transition: width 0.8s ease;
            position: relative;
        }

        .metric-value {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8em;
            font-weight: bold;
            color: #fff;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        /* Score Color Classes */
        .score-excellent {
            background: linear-gradient(135deg, #00ff88, #00cc66);
            border-color: #00ff88;
        }

        .score-good {
            background: linear-gradient(135deg, #66cc99, #4da676);
            border-color: #66cc99;
        }

        .score-fair {
            background: linear-gradient(135deg, #ffaa00, #cc8800);
            border-color: #ffaa00;
        }

        .score-poor {
            background: linear-gradient(135deg, #ff6600, #cc5500);
            border-color: #ff6600;
        }

        .score-critical {
            background: linear-gradient(135deg, #ff0066, #cc0044);
            border-color: #ff0066;
            animation: pulse-score 2s infinite;
        }

        @keyframes pulse-score {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .score-recommendations {
            background: rgba(10, 10, 30, 0.8);
            border-radius: 15px;
            padding: 20px;
        }

        .recommendation {
            margin-bottom: 15px;
            padding: 12px;
            background: rgba(100, 100, 255, 0.1);
            border-left: 3px solid var(--glow-color);
            border-radius: 8px;
            line-height: 1.5;
        }

        .recommendation:last-child {
            margin-bottom: 0;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .score-chart {
                grid-template-columns: 1fr;
                text-align: center;
            }

            .overall-score-circle {
                width: 120px;
                height: 120px;
            }

            .score-number {
                font-size: 2em;
            }

            .metric-label {
                min-width: 120px;
            }
        }

        /* --- Loading, Toasts & Other UI --- */
        .loading { display: none; text-align: center; padding: 40px; }
        .neural-loader { width: 80px; height: 80px; margin: 0 auto 20px; border: 3px solid var(--border-color); border-top: 3px solid var(--glow-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .progress-container {
            max-width: 400px;
            margin: 20px auto;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(100, 100, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--glow-color), #00ccaa);
            border-radius: 10px;
            width: 0%;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .progress-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
            color: var(--secondary-text);
        }

        #progressPercentage {
            font-weight: bold;
            color: var(--glow-color);
        }

        #timeRemaining {
            font-style: italic;
        }

        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 15px 25px; border-radius: 50px; z-index: 1000; opacity: 0; transition: opacity 0.3s, bottom 0.3s; }
        .toast.show { opacity: 1; bottom: 40px; }
        .toast.error { background: #800; }

        /* --- App Pages Layout --- */
        .app-page {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #0a0a0f; /* Solid background matching the overlay */
            min-height: 100vh;
            color: var(--primary-text);
            box-sizing: border-box;
        }

        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .page-header .left-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .back-btn {
            background: rgba(100, 100, 255, 0.1);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 10px 20px;
            color: var(--primary-text);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(100, 100, 255, 0.2);
            border-color: var(--glow-color);
        }

        /* --- Dashboard Styles --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto;
            gap: 20px;
        }

        .dashboard-panel {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(10px);
        }

        .dashboard-panel h3 {
            color: var(--primary-text);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .overview-panel {
            grid-column: 1 / -1;
        }

        .kpi-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .kpi-card {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }

        .kpi-number {
            font-size: 2em;
            font-weight: bold;
            color: var(--glow-color);
            margin-bottom: 5px;
        }

        .kpi-label {
            color: var(--secondary-text);
            font-size: 0.9em;
        }

        .activity-feed {
            max-height: 300px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(0, 255, 136, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .recommendations-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .recommendation-card {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 15px;
            background: rgba(100, 100, 255, 0.1);
            border-radius: 15px;
        }

        .rec-icon {
            font-size: 2em;
        }

        .rec-content h4 {
            color: var(--primary-text);
            margin-bottom: 5px;
        }

        .rec-content p {
            color: var(--secondary-text);
            font-size: 0.9em;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }

        .quick-action-btn {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.2), rgba(0, 204, 170, 0.2));
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 15px;
            padding: 20px 15px;
            color: var(--primary-text);
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .quick-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.3);
        }

        .quick-action-btn span {
            font-size: 1.5em;
        }

        /* --- Pie Chart Styles --- */
        .chart-container {
            display: flex;
            align-items: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .pie-chart {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            position: relative;
            background: conic-gradient(from 0deg,
                #00ff88 0deg 90deg,
                #ff6b6b 90deg 180deg,
                #4ecdc4 180deg 270deg,
                #45b7d1 270deg 360deg
            );
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.3);
        }

        .pie-chart.empty {
            background: #333;
            border: 2px dashed #555;
        }

        .chart-legend {
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 200px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .legend-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .legend-text {
            display: flex;
            justify-content: space-between;
            flex: 1;
            font-size: 14px;
        }

        .legend-label {
            color: var(--primary-text);
            font-weight: 500;
        }

        .legend-percentage {
            color: var(--secondary-text);
            font-weight: 600;
        }

        /* --- Bookmarks Page Styles --- */
        .bookmarks-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: var(--surface-color);
            border-radius: 20px;
            border: 1px solid var(--border-color);
        }

        .bookmarks-search {
            display: flex;
            gap: 10px;
            flex: 1;
            min-width: 300px;
        }

        .search-input {
            flex: 1;
            padding: 12px 20px;
            background: rgba(10, 10, 20, 0.8);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            color: var(--primary-text);
        }

        .search-btn {
            padding: 12px 20px;
            background: var(--glow-color);
            border: none;
            border-radius: 15px;
            color: #000;
            cursor: pointer;
        }

        .bookmarks-filters, .bookmarks-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filter-select, .bulk-action-btn {
            padding: 10px 15px;
            background: rgba(100, 100, 255, 0.1);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--primary-text);
            cursor: pointer;
        }

        .delete-btn {
            background: rgba(255, 50, 50, 0.2);
            border-color: rgba(255, 50, 50, 0.5);
        }

        .bookmarks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .bookmark-card {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .bookmark-card:hover {
            border-color: var(--glow-color);
            box-shadow: 0 5px 20px rgba(0, 255, 136, 0.2);
        }

        .bookmark-card.selected {
            border-color: var(--glow-color);
            background: rgba(0, 255, 136, 0.1);
        }

        .bookmark-checkbox {
            position: absolute;
            top: 15px;
            right: 15px;
        }

        .bookmark-categories,
        .bookmark-tags {
            margin-top: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }

        .category-tag {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 500;
            border: 1px solid rgba(0, 255, 136, 0.3);
        }

        .bookmark-tag {
            background: rgba(100, 100, 255, 0.2);
            color: #6464ff;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.7em;
            border: 1px solid rgba(100, 100, 255, 0.3);
        }

        .bookmark-score {
            position: absolute;
            top: 15px;
            left: 15px;
            background: linear-gradient(135deg, var(--glow-color), #00ccaa);
            color: #000;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.8em;
        }

        .bookmark-title {
            margin: 30px 0 10px 0;
            color: var(--primary-text);
            font-weight: 600;
        }

        .bookmark-url {
            color: var(--secondary-text);
            font-size: 0.8em;
            margin-bottom: 10px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .bookmark-date {
            color: var(--secondary-text);
            font-size: 0.8em;
        }

        /* --- Settings Page Styles --- */
        .settings-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 30px;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            overflow: hidden;
        }

        .settings-nav {
            background: rgba(10, 10, 20, 0.5);
            padding: 20px 0;
        }

        .settings-nav-item {
            padding: 15px 25px;
            color: var(--secondary-text);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .settings-nav-item:hover {
            background: rgba(0, 255, 136, 0.1);
            color: var(--primary-text);
        }

        .settings-nav-item.active {
            background: rgba(0, 255, 136, 0.2);
            color: var(--glow-color);
            border-right: 3px solid var(--glow-color);
        }

        .settings-content {
            padding: 30px;
        }

        .settings-section {
            display: none;
        }

        .settings-section.active {
            display: block;
        }

        .settings-section h3 {
            color: var(--primary-text);
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-form {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            color: var(--primary-text);
            font-weight: 500;
        }

        .form-group small {
            color: var(--secondary-text);
            font-size: 0.8em;
        }

        .settings-input, .settings-textarea, .settings-select {
            padding: 12px 16px;
            background: rgba(10, 10, 20, 0.8);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--primary-text);
            font-size: 1em;
        }

        .settings-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .settings-input:focus, .settings-textarea:focus, .settings-select:focus {
            outline: none;
            border-color: var(--glow-color);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.2);
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 25px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #333;
            border-radius: 25px;
            transition: 0.3s;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 19px;
            width: 19px;
            left: 3px;
            bottom: 3px;
            background: #fff;
            border-radius: 50%;
            transition: 0.3s;
        }

        input:checked + .toggle-slider {
            background: var(--glow-color);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(25px);
        }

        .settings-save-btn, .secondary-btn, .danger-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            align-self: flex-start;
        }

        .settings-save-btn {
            background: linear-gradient(135deg, var(--glow-color), #00ccaa);
            color: #000;
        }

        .secondary-btn {
            background: rgba(100, 100, 255, 0.2);
            color: var(--primary-text);
            border: 1px solid var(--border-color);
        }

        .danger-btn {
            background: rgba(255, 50, 50, 0.2);
            color: #ff6666;
            border: 1px solid rgba(255, 50, 50, 0.5);
        }

        .danger-zone {
            border-top: 1px solid rgba(255, 50, 50, 0.3);
            padding-top: 20px;
            margin-top: 20px;
        }

        .storage-info {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .storage-bar {
            width: 100%;
            height: 8px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
        }

        .storage-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--glow-color), #00ccaa);
            border-radius: 10px;
        }

        .loading-placeholder {
            text-align: center;
            color: var(--secondary-text);
            padding: 40px;
            font-style: italic;
        }

        /* --- Mobile Responsiveness --- */
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .kpi-cards {
                grid-template-columns: repeat(2, 1fr);
            }

            .settings-container {
                grid-template-columns: 1fr;
            }

            .settings-nav {
                display: flex;
                overflow-x: auto;
                padding: 10px;
            }

            .settings-nav-item {
                white-space: nowrap;
                border-right: none;
                border-bottom: 3px solid transparent;
            }

            .settings-nav-item.active {
                border-right: none;
                border-bottom-color: var(--glow-color);
            }

            .bookmarks-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .bookmarks-search {
                min-width: auto;
            }

            .bookmarks-grid {
                grid-template-columns: 1fr;
            }

            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .context-link { color: var(--glow-color); text-decoration: none; font-size: 0.8em; margin-left: 5px; }
        mark.flash-highlight { background-color: var(--glow-color); color: #000; animation: flash 2s; }
        @keyframes flash { 50% { background-color: inherit; color: inherit; } }

        /* --- Footer --- */
        footer {
            text-align: center;
            padding: 40px 20px;
            color: var(--secondary-text);
            font-size: 0.9em;
        }
        .footer-icons { margin-top: 15px; display: flex; justify-content: center; gap: 20px; }
        .footer-icons a { color: var(--secondary-text); transition: color 0.3s; }
        .footer-icons a:hover { color: var(--glow-color); }
        .footer-icons svg { width: 24px; height: 24px; }
        
        /* --- Enhanced Responsive Design --- */
        @media (max-width: 768px) {
            .container { padding: 15px; }

            h1 { font-size: 1.8em; letter-spacing: 1px; }
            .subtitle { font-size: 1em; }

            header { padding: 25px 20px; margin-bottom: 20px; }

            .features-grid { grid-template-columns: 1fr; gap: 15px; }
            .features-column { justify-content: flex-start; }

            .button-container {
                flex-direction: column;
                gap: 15px;
                align-items: center;
            }

            .analyze-btn, .random-btn, .reset-btn {
                width: 100%;
                max-width: 300px;
                padding: 18px 0;
                font-size: 1em;
            }

            .carousel-page { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .carousel-container { padding: 0 20px; }
            .carousel-nav.prev { left: -10px; }
            .carousel-nav.next { right: -10px; }

            .analysis-results {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .result-card { padding: 20px; }

            .item-header {
                flex-wrap: wrap;
                gap: 8px;
                justify-content: flex-start;
            }

            .rank-badge { min-width: 30px; font-size: 0.7em; }
            .status-badge { font-size: 0.65em; padding: 3px 8px; }
            .tag-badge { font-size: 0.65em; padding: 2px 6px; }

            .source-text-section, .blueprint-section, .research-score-section {
                padding: 20px;
                margin-top: 20px;
            }

            .json-section-title { padding: 10px 15px; font-size: 1em; }
            .json-section-content { padding: 15px; }
        }

        @media (max-width: 480px) {
            .container { padding: 10px; }

            h1 { font-size: 1.6em; }
            header { padding: 20px 15px; }

            .carousel-page { grid-template-columns: 1fr; }
            .category-btn { padding: 12px; font-size: 0.85em; }

            .overall-score-circle {
                width: 100px;
                height: 100px;
            }

            .score-number { font-size: 1.8em; }
            .metric-label { min-width: 100px; font-size: 0.8em; }

            .item-content { margin-left: 10px; }
        }

        /* Search & Filter Controls */
        .search-controls {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }

        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }

        .search-input {
            flex: 1;
            padding: 12px 20px;
            background: rgba(10, 10, 20, 0.8);
            border: 2px solid var(--border-color);
            border-radius: 25px;
            color: var(--primary-text);
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--glow-color);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }

        .search-btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, var(--glow-color), #00ffff);
            color: #000;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .search-btn:hover {
            transform: scale(1.05);
        }

        .filter-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 10px 15px;
            background: rgba(10, 10, 20, 0.8);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            color: var(--primary-text);
            font-size: 0.9em;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--glow-color);
        }

        .clear-filters-btn {
            padding: 10px 20px;
            background: rgba(255, 100, 100, 0.2);
            color: var(--primary-text);
            border: 1px solid rgba(255, 100, 100, 0.4);
            border-radius: 15px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .clear-filters-btn:hover {
            background: rgba(255, 100, 100, 0.3);
            border-color: rgba(255, 100, 100, 0.6);
        }

        @media (max-width: 768px) {
            .search-controls { padding: 20px 15px; }
            .search-bar { flex-direction: column; align-items: stretch; }
            .search-btn { align-self: center; width: 120px; }
            .filter-controls { justify-content: center; }
            .filter-select { min-width: 120px; }
        }

        /* Export Controls */
        .export-controls {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 25px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
            text-align: center;
        }

        .export-controls h3 {
            color: var(--glow-color);
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .export-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .export-btn {
            padding: 12px 25px;
            border-radius: 25px;
            border: none;
            font-size: 0.9em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: 140px;
        }

        .csv-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: #fff;
        }

        .pdf-btn {
            background: linear-gradient(135deg, #dc3545, #e83e8c);
            color: #fff;
        }

        .json-btn {
            background: linear-gradient(135deg, #6f42c1, #6610f2);
            color: #fff;
        }

        .copy-btn {
            background: linear-gradient(135deg, #fd7e14, #ffc107);
            color: #000;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .export-btn:active {
            transform: translateY(0);
        }

        @media (max-width: 768px) {
            .export-buttons {
                flex-direction: column;
                align-items: center;
            }

            .export-btn {
                width: 100%;
                max-width: 300px;
            }
        }

        /* Authentication Modal Styles */
        .auth-signin-btn {
            background: linear-gradient(135deg, var(--glow-color), #00ccaa);
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
        }

        .auth-signin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 255, 136, 0.4);
        }

        .auth-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }

        .auth-modal {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            backdrop-filter: blur(20px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .auth-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .auth-header h2 {
            color: var(--glow-color);
            margin: 0;
            font-size: 1.5em;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--primary-text);
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background 0.3s ease;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .auth-benefits {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .auth-benefits h3 {
            color: var(--glow-color);
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .auth-benefits ul {
            margin: 0;
            padding-left: 20px;
            color: var(--primary-text);
        }

        .auth-benefits li {
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .auth-input {
            padding: 12px 16px;
            background: rgba(10, 10, 20, 0.8);
            border: 2px solid var(--border-color);
            border-radius: 15px;
            color: var(--primary-text);
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .auth-input:focus {
            outline: none;
            border-color: var(--glow-color);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }

        .auth-submit {
            background: linear-gradient(135deg, var(--glow-color), #00ffff);
            color: #000;
            border: none;
            padding: 15px;
            border-radius: 25px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .auth-submit:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.4);
        }

        .auth-submit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .auth-error {
            background: rgba(255, 0, 100, 0.1);
            border: 1px solid rgba(255, 0, 100, 0.3);
            color: #ff0064;
            padding: 12px;
            border-radius: 10px;
            font-size: 0.9em;
            text-align: center;
        }

        .auth-switch {
            text-align: center;
            margin-top: 20px;
            color: var(--secondary-text);
        }

        .auth-link {
            background: none;
            border: none;
            color: var(--glow-color);
            cursor: pointer;
            text-decoration: underline;
            font-size: inherit;
        }

        .auth-link:hover {
            color: #00ffff;
        }

        .auth-footer {
            margin-top: 20px;
            text-align: center;
        }

        .privacy-note {
            font-size: 0.8em;
            color: var(--secondary-text);
            margin: 0;
            line-height: 1.4;
        }

        /* User Menu Styles */
        .user-menu {
            position: relative;
            z-index: 9999;
        }

        .user-menu-button {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 25px;
            padding: 8px 16px;
            color: var(--primary-text);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-menu-button:hover {
            border-color: var(--glow-color);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--glow-color), #00ffff);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #000;
            text-transform: uppercase;
        }

        .user-name {
            font-weight: 500;
        }

        .dropdown-arrow {
            font-size: 0.8em;
            transition: transform 0.3s ease;
        }

        .user-menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 10px;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 15px;
            min-width: 200px;
            backdrop-filter: blur(20px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            animation: slideDown 0.2s ease;
            /* Prevent dropdown from being clipped */
            max-height: 300px;
            overflow-y: auto;
            /* Ensure it doesn't get blocked */
            pointer-events: auto;
        }

        .user-menu-dropdown-portal {
            position: fixed;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 15px;
            min-width: 200px;
            backdrop-filter: blur(20px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            animation: slideDown 0.2s ease;
            max-height: 300px;
            overflow-y: auto;
            pointer-events: auto;
        }

        .user-info {
            margin-bottom: 10px;
        }

        .user-info strong {
            display: block;
            color: var(--primary-text);
            margin-bottom: 2px;
        }

        .user-info small {
            color: var(--secondary-text);
            font-size: 0.8em;
        }

        .menu-item {
            width: 100%;
            background: none;
            border: none;
            color: var(--primary-text);
            padding: 10px;
            text-align: left;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
            font-size: 0.9em;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .menu-item.sign-out {
            color: #ff6b6b;
        }

        .menu-item.sign-out:hover {
            background: rgba(255, 107, 107, 0.1);
        }

        .auth-prompt {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(0, 255, 255, 0.1));
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 25px;
            margin: 20px 0;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .auth-prompt h3 {
            color: var(--glow-color);
            margin-top: 0;
            margin-bottom: 15px;
        }

        .auth-prompt p {
            color: var(--primary-text);
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .auth-prompt-btn {
            background: linear-gradient(135deg, var(--glow-color), #00ffff);
            color: #000;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 0 10px;
        }

        .auth-prompt-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.4);
        }

        .auth-prompt-btn.secondary {
            background: transparent;
            color: var(--primary-text);
            border: 1px solid var(--border-color);
        }

        .auth-prompt-btn.secondary:hover {
            border-color: var(--glow-color);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
        }

    </style>
</head>
<body>
    <div class="neural-bg"></div>
    
    <div class="container">
        <header>
            <div class="header-content">
                <div class="header-main">
                    <h1>Synaptic Insight Engine</h1>
                    <p class="subtitle">Extract Exploits → Identify Gaps → Generate Blueprints → Build MVPs</p>
                </div>
                <div class="header-auth" id="authContainer">
                    <!-- Authentication components will be rendered here -->
                </div>
            </div>
        </header>

        <div class="input-section">
            <form id="analyzeForm">
                <input type="url" class="url-input" id="urlInput" placeholder="Enter case study URL (e.g., https://arxiv.org/abs/1234.56789)" aria-label="Case Study URL Input" required>
                <div class="features-grid">
                    <div class="features-column">
                        <div>
                            <h3><span class="card-icon" style="font-size: 0.8em; width: 24px; height: 24px;">🔬</span> Standard Analysis</h3>
                            <ul>
                                <li>Unscientific claims & money-making tactics</li>
                                <li>Knowledge gaps & missing data</li>
                                <li>Opportunities for legitimate solutions</li>
                                <li>Growth mechanics based on mathematical models</li>
                            </ul>
                        </div>
                    </div>
                    <div class="features-column">
                        <div>
                            <h3><span class="card-icon" style="font-size: 0.8em; width: 24px; height: 24px;">��</span> Premium Analysis</h3>
                            <ul>
                                <li>Market viability scoring</li>
                                <li>Suggested MVP feature set</li>
                                <li>Potential funding avenues</li>
                                <li>Ethical consideration flags</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="button-container">
                    <button type="button" class="random-btn" onclick="loadRandomExample()" aria-label="Load a random example URL">🎲 Try a Random Example</button>
                    <button type="submit" class="analyze-btn" aria-label="Analyze the provided case study URL">💎 Analyze Case Study</button>
                    <button type="button" class="reset-btn" onclick="resetUI()" aria-label="Reset the analysis fields">🔄 Reset</button>
                </div>
            </form>
            <div id="error" style="color: red; text-align: center; margin-top: 15px;"></div>
        </div>

        <div class="category-section" id="domainCarousel">
            <h2 class="category-title">Or, Select a Research Domain to Find a Case Study</h2>
            <div class="carousel-container">
                <div class="carousel-pages" id="carouselPages">
                    <!-- Carousel pages will be generated by JavaScript -->
                </div>
                <!-- Key fix for arrows - replaced characters with SVG -->
                <div class="carousel-nav prev" onclick="prevCarouselPage()" aria-label="Previous page of research domains">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                </div>
                <div class="carousel-nav next" onclick="nextCarouselPage()" aria-label="Next page of research domains">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </div>
            </div>
            <div class="carousel-indicators" id="carouselIndicators">
                <!-- Indicators will be generated by JavaScript -->
            </div>
        </div>
        
        <div class="loading" id="loadingSection">
            <div class="neural-loader"></div>
            <p id="loadingText">Processing neural pathways...</p>

            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-stats">
                    <span id="progressPercentage">0%</span>
                    <span id="timeRemaining">Estimating time...</span>
                </div>
            </div>
        </div>
        
        <!-- Main Application Pages -->
        <div id="mainApp" style="display: block;">
            <div class="analysis-results" id="results"></div>
            <div class="source-text-section" id="sourceTextSection"></div>
        </div>

        <!-- Dashboard Page -->
        <div id="dashboardPage" class="app-page" style="display: none;">
            <div class="page-header">
                <div class="left-section">
                    <button onclick="navigateToPage('main')" class="back-btn">← Back to Analysis</button>
                    <h2>📊 Research Dashboard</h2>
                </div>
                <div class="auth-container" id="authContainerDashboard">
                    <!-- User menu will be populated here -->
                </div>
            </div>

            <div class="dashboard-grid">
                <!-- Overview Panel -->
                <div class="dashboard-panel overview-panel">
                    <h3>📈 Overview</h3>
                    <div class="kpi-cards">
                        <div class="kpi-card">
                            <div class="kpi-number" id="totalAnalyses">0</div>
                            <div class="kpi-label">Total Analyses</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-number" id="totalBookmarks">0</div>
                            <div class="kpi-label">Bookmarked Papers</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-number" id="avgQualityScore">--</div>
                            <div class="kpi-label">Avg Quality Score</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-number" id="daysSinceLastAnalysis">--</div>
                            <div class="kpi-label">Days Since Last</div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity Panel -->
                <div class="dashboard-panel activity-panel">
                    <h3>🔍 Recent Activity</h3>
                    <div class="activity-feed" id="activityFeed">
                        <div class="loading-placeholder">Loading recent activity...</div>
                    </div>
                </div>

                <!-- Recommendations Panel -->
                <div class="dashboard-panel recommendations-panel">
                    <h3>💡 Smart Recommendations</h3>
                    <div class="recommendations-list" id="recommendationsList">
                        <div class="recommendation-card">
                            <div class="rec-icon">📚</div>
                            <div class="rec-content">
                                <h4>Analyze More Papers</h4>
                                <p>Try analyzing papers from different domains to broaden your research scope.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Research Topics Chart Panel -->
                <div class="dashboard-panel topics-chart-panel">
                    <h3>📈 Research Topics Analysis</h3>
                    <div class="chart-container">
                        <div class="pie-chart" id="topicsChart">
                            <div class="loading-placeholder">Loading topic analysis...</div>
                        </div>
                        <div class="chart-legend" id="chartLegend">
                            <!-- Legend items will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Quick Actions Panel -->
                <div class="dashboard-panel quick-actions-panel">
                    <h3>⚡ Quick Actions</h3>
                    <div class="quick-actions">
                        <button onclick="navigateToPage('main')" class="quick-action-btn">
                            <span>🔬</span> New Analysis
                        </button>
                        <button onclick="navigateToPage('bookmarks')" class="quick-action-btn">
                            <span>⭐</span> View Bookmarks
                        </button>
                        <button onclick="exportAllAnalyses()" class="quick-action-btn">
                            <span>📊</span> Export Data
                        </button>
                        <button onclick="navigateToPage('settings')" class="quick-action-btn">
                            <span>⚙️</span> Settings
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bookmarks Page -->
        <div id="bookmarksPage" class="app-page" style="display: none;">
            <div class="page-header">
                <div class="left-section">
                    <button onclick="navigateToPage('main')" class="back-btn">← Back to Analysis</button>
                    <h2>⭐ Your Bookmarks</h2>
                </div>
                <div class="auth-container" id="authContainerBookmarks">
                    <!-- User menu will be populated here -->
                </div>
            </div>

            <div class="bookmarks-controls">
                <div class="bookmarks-search">
                    <input type="text" id="bookmarkSearch" placeholder="Search bookmarks..." class="search-input" oninput="filterBookmarks()">
                    <button onclick="filterBookmarks()" class="search-btn">🔍</button>
                </div>
                <div class="bookmarks-filters">
                    <select id="bookmarkSort" onchange="sortBookmarks()" class="filter-select">
                        <option value="date-newest">Newest First</option>
                        <option value="date-oldest">Oldest First</option>
                        <option value="score-high">Highest Score</option>
                        <option value="score-low">Lowest Score</option>
                        <option value="title-az">Title A-Z</option>
                        <option value="title-za">Title Z-A</option>
                    </select>
                    <button onclick="clearBookmarkFilters()" class="clear-filters-btn">Clear</button>
                </div>
                <div class="bookmarks-actions">
                    <button onclick="selectAllBookmarks()" class="bulk-action-btn">Select All</button>
                    <button onclick="exportSelectedBookmarks()" class="bulk-action-btn">Export Selected</button>
                    <button onclick="deleteSelectedBookmarks()" class="bulk-action-btn delete-btn">Delete Selected</button>
                </div>
            </div>

            <div class="bookmarks-grid" id="bookmarksGrid">
                <div class="loading-placeholder">Loading bookmarks...</div>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="settingsPage" class="app-page" style="display: none;">
            <div class="page-header">
                <div class="left-section">
                    <button onclick="navigateToPage('main')" class="back-btn">← Back to Analysis</button>
                    <h2>⚙️ Settings</h2>
                </div>
                <div class="auth-container" id="authContainerSettings">
                    <!-- User menu will be populated here -->
                </div>
            </div>

            <div class="settings-container">
                <div class="settings-nav">
                    <div class="settings-nav-item active" onclick="showSettingsSection('profile')">
                        <span>👤</span> Profile
                    </div>
                    <div class="settings-nav-item" onclick="showSettingsSection('preferences')">
                        <span>🎨</span> Preferences
                    </div>
                    <div class="settings-nav-item" onclick="showSettingsSection('notifications')">
                        <span>🔔</span> Notifications
                    </div>
                    <div class="settings-nav-item" onclick="showSettingsSection('security')">
                        <span>🔒</span> Security
                    </div>
                    <div class="settings-nav-item" onclick="showSettingsSection('data')">
                        <span>💾</span> Data & Export
                    </div>
                </div>

                <div class="settings-content">
                    <!-- Profile Section -->
                    <div id="profileSettings" class="settings-section active">
                        <h3>Profile Information</h3>
                        <div class="settings-form">
                            <div class="form-group">
                                <label for="profileName">Display Name</label>
                                <input type="text" id="profileName" class="settings-input" placeholder="Your name">
                            </div>
                            <div class="form-group">
                                <label for="profileEmail">Email Address</label>
                                <input type="email" id="profileEmail" class="settings-input" placeholder="your@email.com" readonly>
                                <small>Email cannot be changed. Contact support if needed.</small>
                            </div>
                            <div class="form-group">
                                <label for="profileBio">Research Interests</label>
                                <textarea id="profileBio" class="settings-textarea" placeholder="Describe your research interests..."></textarea>
                            </div>
                            <button onclick="saveProfileSettings()" class="settings-save-btn">Save Changes</button>
                        </div>
                    </div>

                    <!-- Preferences Section -->
                    <div id="preferencesSettings" class="settings-section">
                        <h3>Analysis Preferences</h3>
                        <div class="settings-form">
                            <div class="form-group">
                                <label>Default Analysis Depth</label>
                                <select id="analysisDepth" class="settings-select">
                                    <option value="standard">Standard Analysis</option>
                                    <option value="detailed">Detailed Analysis</option>
                                    <option value="comprehensive">Comprehensive Analysis</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Auto-save Analyses</label>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="autoSaveAnalyses" checked>
                                    <span class="toggle-slider"></span>
                                </div>
                                <small>Automatically save all analyses to your history</small>
                            </div>
                            <div class="form-group">
                                <label>Show Progress Details</label>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="showProgressDetails" checked>
                                    <span class="toggle-slider"></span>
                                </div>
                                <small>Display detailed progress information during analysis</small>
                            </div>
                            <button onclick="savePreferences()" class="settings-save-btn">Save Preferences</button>
                        </div>
                    </div>

                    <!-- Notifications Section -->
                    <div id="notificationsSettings" class="settings-section">
                        <h3>Notification Settings</h3>
                        <div class="settings-form">
                            <div class="form-group">
                                <label>Analysis Complete Notifications</label>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="analysisNotifications" checked>
                                    <span class="toggle-slider"></span>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Weekly Summary Email</label>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="weeklySummary">
                                    <span class="toggle-slider"></span>
                                </div>
                                <small>Receive a weekly summary of your research activity</small>
                            </div>
                            <button onclick="saveNotificationSettings()" class="settings-save-btn">Save Settings</button>
                        </div>
                    </div>

                    <!-- Security Section -->
                    <div id="securitySettings" class="settings-section">
                        <h3>Security & Privacy</h3>
                        <div class="settings-form">
                            <div class="form-group">
                                <label>Change Password</label>
                                <button onclick="initiatePasswordChange()" class="secondary-btn">Change Password</button>
                                <small>You'll receive an email with instructions</small>
                            </div>
                            <div class="form-group">
                                <label>Data Retention</label>
                                <select id="dataRetention" class="settings-select">
                                    <option value="forever">Keep Forever</option>
                                    <option value="1year">1 Year</option>
                                    <option value="6months">6 Months</option>
                                    <option value="3months">3 Months</option>
                                </select>
                                <small>How long to keep your analysis data</small>
                            </div>
                            <div class="form-group danger-zone">
                                <label>Danger Zone</label>
                                <button onclick="confirmDeleteAccount()" class="danger-btn">Delete Account</button>
                                <small>This action cannot be undone</small>
                            </div>
                        </div>
                    </div>

                    <!-- Data & Export Section -->
                    <div id="dataSettings" class="settings-section">
                        <h3>Data Management</h3>
                        <div class="settings-form">
                            <div class="form-group">
                                <label>Export All Data</label>
                                <button onclick="exportAllUserData()" class="secondary-btn">Download My Data</button>
                                <small>Download all your analyses, bookmarks, and settings</small>
                            </div>
                            <div class="form-group">
                                <label>Storage Usage</label>
                                <div class="storage-info">
                                    <div class="storage-bar">
                                        <div class="storage-fill" id="storageUsage" style="width: 25%"></div>
                                    </div>
                                    <small id="storageText">Used 2.5 MB of 10 MB available</small>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Clear All Data</label>
                                <button onclick="confirmClearAllData()" class="danger-btn">Clear All Data</button>
                                <small>Remove all analyses and bookmarks (account remains)</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
            <div class="dropdown-header" onclick="toggleSourceText()">
                <h2 class="section-title">📝 Analyzed Source Text</h2>
                <span class="dropdown-arrow" id="sourceTextArrow">▼</span>
            </div>
            <div class="source-text-content collapsed" id="sourceTextContent"></div>
        </div>

        <div class="blueprint-section" id="blueprintSection">
            <h2 class="section-title">📋 Generated Blueprint</h2>
            <div class="blueprint-content" id="blueprintContent"></div>
            <button class="random-btn" onclick="downloadBlueprint()" aria-label="Download the generated blueprint as a text file" style="background: #334;">⬇ Download Blueprint</button>
        </div>
    </div>
    
    <footer>
        <p>Created by Ryan Guidry 🦄 <a href="https://rguidry.dev" target="_blank" rel="noopener noreferrer" style="color: #27ae60; font-weight: bold;">rguidry.dev</a></p>
        <div class="footer-icons">
            <a href="https://linkedin.com/in/rmguidry" target="_blank" rel="noopener noreferrer" aria-label="Ryan Guidry's LinkedIn Profile">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
            </a>
            <a href="https://github.com/rguid31" target="_blank" rel="noopener noreferrer" aria-label="Ryan Guidry's GitHub Profile">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
            </a>
        </div>
    </footer>

    <script>
        // --- DOM ELEMENTS ---
        const urlInput = document.getElementById('urlInput');
        const analyzeForm = document.getElementById('analyzeForm');
        const errorDiv = document.getElementById('error');
        const resultsDiv = document.getElementById('results');
        const loadingDiv = document.querySelector('.loading');
        const blueprintSection = document.getElementById('blueprintSection');
        const blueprintContent = document.getElementById('blueprintContent');
        const sourceTextSection = document.getElementById('sourceTextSection');
        const sourceTextContent = document.getElementById('sourceTextContent');
        const carouselPagesContainer = document.getElementById('carouselPages');
        const carouselIndicators = document.getElementById('carouselIndicators');

        // --- GLOBAL STATE ---
        let currentAnalysisResult = null;
        let currentPage = 0;
        let analysisHistory = JSON.parse(localStorage.getItem('analysisHistory') || '[]');
        let bookmarkedPapers = JSON.parse(localStorage.getItem('bookmarkedPapers') || '[]');

        // --- DOMAINS & CAROUSEL SETUP ---
        const domains = [
            { name: "AI/ML", icon: "🤖", url: "https://arxiv.org/list/cs.AI/recent" },
            { name: "AI in Drug Discovery", icon: "💊", url: "https://scholar.google.com/scholar?q=AI+in+drug+discovery" },
            { name: "Biotechnology", icon: "🧬", url: "https://arxiv.org/list/q-bio.BM/recent" },
            { name: "Data Science", icon: "📊", url: "https://arxiv.org/list/cs.DB/recent" },
            { name: "Personalized Med", icon: "🩺", url: "https://scholar.google.com/scholar?q=personalized+medicine" },
            { name: "Cybersecurity", icon: "🛡️", url: "https://arxiv.org/list/cs.CR/recent" },
            { name: "Climate Mitigation", icon: "🌍", url: "https://scholar.google.com/scholar?q=climate+change+mitigation" },
            { name: "Sustainable Agri", icon: "🌾", url: "https://scholar.google.com/scholar?q=sustainable+agriculture" },
            { name: "Quantum Computing", icon: "🌀", url: "https://arxiv.org/list/quant-ph/recent" },
            { name: "Neurodegenerative", icon: "🧠", url: "https://scholar.google.com/scholar?q=neurodegenerative+disease+research" },
            { name: "Blockchain", icon: "🔗", url: "https://scholar.google.com/scholar?q=blockchain+technology" },
            { name: "Waste Management", icon: "♻️", url: "https://scholar.google.com/scholar?q=waste+management+circular+economy" },
            { name: "Space Exploration", icon: "🚀", url: "https://arxiv.org/list/astro-ph/recent" },
            { name: "Advanced Materials", icon: "🔩", url: "https://scholar.google.com/scholar?q=advanced+materials+research" },
            { name: "Robotics & Automation", icon: "🤖", url: "https://arxiv.org/list/cs.RO/recent" },
            { name: "Bioinformatics", icon: "💻", url: "https://scholar.google.com/scholar?q=bioinformatics" },
            { name: "Renewable Energy", icon: "☀️", url: "https://scholar.google.com/scholar?q=renewable+energy+technology" },
            { name: "Mental Health Research", icon: "🧘", url: "https://scholar.google.com/scholar?q=mental+health+research" },
            { name: "Ecosystem Conservation", icon: "🌳", url: "https://scholar.google.com/scholar?q=ecosystem+conservation" },
            { name: "Sociology", icon: "👥", url: "https://scholar.google.com/scholar?q=sociology+research" },
            { name: "Business/Economics", icon: "📈", url: "https://arxiv.org/list/econ.GN/recent" },
            { name: "Physics", icon: "⚛️", url: "https://arxiv.org/list/physics/recent" },
            { name: "AI Engineering", icon: "⚙️", url: "https://scholar.google.com/scholar?q=AI+engineering" },
            { name: "Nanotechnology", icon: "🔬", url: "https://scholar.google.com/scholar?q=nanotechnology" }
        ];

        const totalPages = Math.ceil(domains.length / 8);

        function setupCarousel() {
            carouselPagesContainer.innerHTML = '';
            carouselIndicators.innerHTML = '';

            for (let i = 0; i < totalPages; i++) {
                const page = document.createElement('div');
                page.className = 'carousel-page';
                if (i === 0) page.classList.add('active');

                const pageDomains = domains.slice(i * 8, (i + 1) * 8);
                pageDomains.forEach((domain, index) => {
                    const domainIndex = i * 8 + index;
                    page.innerHTML += `
                        <div class="category-btn" onclick="window.open('${domain.url}', '_blank')" aria-label="Find case studies in ${domain.name}">
                            <span class="category-icon">${domain.icon}</span>
                            ${domainIndex + 1}. ${domain.name}
                        </div>
                    `;
                });
                carouselPagesContainer.appendChild(page);

                const indicator = document.createElement('div');
                indicator.className = 'indicator';
                if (i === 0) indicator.classList.add('active');
                indicator.onclick = () => goToPage(i);
                carouselIndicators.appendChild(indicator);
            }
        }

        function updateCarousel() {
            const offset = -currentPage * (100 + 5);
            carouselPagesContainer.style.transform = `translateX(${offset}%)`;
            document.querySelectorAll('.indicator').forEach((ind, i) => ind.classList.toggle('active', i === currentPage));
        }

        function nextCarouselPage() {
            currentPage = (currentPage + 1) % totalPages;
            updateCarousel();
        }

        function prevCarouselPage() {
            currentPage = (currentPage - 1 + totalPages) % totalPages;
            updateCarousel();
        }

        function goToPage(pageNumber) {
            currentPage = pageNumber;
            updateCarousel();
        }

        // --- CORE APPLICATION LOGIC ---
        async function analyzeCase() {
            const url = urlInput.value.trim();
            if (!url) {
                showToast('Please enter a valid URL', true);
                errorDiv.textContent = 'Please enter a valid URL';
                return;
            }

            // Validate URL format
            if (url.includes('arxiv.org') && url.includes('.pdf')) {
                showToast('Please use an arXiv abstract URL (e.g., https://arxiv.org/abs/2307.12008), not a PDF.', true);
                errorDiv.textContent = 'Please use an arXiv abstract URL (e.g., https://arxiv.org/abs/2307.12008), not a PDF.';
                return;
            }

            resetUI(true);

            // Auto-scroll to loading section
            const loadingSection = document.getElementById('loadingSection');
            loadingSection.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // Initialize progress tracking
            startProgressTracking();
            updateLoadingText('🔍 Fetching research paper content...');

            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
                if (!response.ok) {
                    const text = await response.text();
                    let errorMessage = `HTTP error! Status: ${response.status}, Body: ${text}`;
                    try {
                        const errorData = JSON.parse(text);
                        errorMessage = errorData.error || errorMessage;
                    } catch (e) {
                        // Non-JSON response
                    }
                    throw new Error(errorMessage);
                }
                const data = await response.json();
                currentAnalysisResult = data;

                // Save to analysis history
                saveToHistory(url, data);

                displayResults(data.analysis);
                displaySourceText(data.structuredData || data.sourceText);
                generateBlueprint();
                addBookmarkButton();
                completeProgress();
                showToast('Analysis complete!');
            } catch (error) {
                console.error('Error during analysis:', error);
                let userMessage = error.message;
                if (userMessage.includes('URL not found')) {
                    userMessage += ' Ensure the arXiv URL is valid (e.g., https://arxiv.org/abs/2307.12008).';
                } else if (userMessage.includes('non-HTML resource')) {
                    userMessage += ' Use an arXiv abstract page (e.g., https://arxiv.org/abs/2307.12008).';
                } else if (userMessage.includes('Access denied') || userMessage.includes('paywall')) {
                    userMessage += ' Try an arXiv abstract URL (e.g., https://arxiv.org/abs/2307.12008) for best results.';
                }
                showToast(userMessage, true);
                errorDiv.textContent = userMessage;
            } finally {
                stopProgressTracking();
                loadingDiv.style.display = 'none';
            }
        }

        function formatRankedItem(item, baseClass) {
            // Handle both old string format and new object format for backward compatibility
            if (typeof item === 'string') {
                return `<div class="${baseClass}">${highlightTextInString(item)}</div>`;
            }

            const statusClass = getStatusClass(item.status);
            const confidenceClass = getConfidenceClass(item.confidence);
            const rankBadge = `<span class="rank-badge rank-${item.rank}">#${item.rank}</span>`;
            const statusBadge = `<span class="status-badge ${statusClass}">${item.status}</span>`;
            const confidenceBadge = item.confidence ? `<span class="confidence-badge ${confidenceClass}">${Math.round(item.confidence * 100)}%</span>` : '';
            const tagsBadges = item.tags ? item.tags.map(tag => `<span class="tag-badge">${tag}</span>`).join('') : '';

            return `
                <div class="${baseClass} ranked-item">
                    <div class="item-header">
                        ${rankBadge}
                        ${statusBadge}
                        ${confidenceBadge}
                        <div class="tags-container">${tagsBadges}</div>
                    </div>
                    <div class="item-content">${highlightTextInString(item.finding || item)}</div>
                </div>
            `;
        }

        function getStatusClass(status) {
            const statusMap = {
                'CRITICAL': 'status-critical',
                'HIGH': 'status-high',
                'MODERATE': 'status-moderate',
                'LOW': 'status-low'
            };
            return statusMap[status] || 'status-moderate';
        }

        function getConfidenceClass(confidence) {
            if (!confidence) return '';
            if (confidence >= 0.9) return 'confidence-very-high';
            if (confidence >= 0.75) return 'confidence-high';
            if (confidence >= 0.6) return 'confidence-medium';
            if (confidence >= 0.4) return 'confidence-low';
            return 'confidence-very-low';
        }

        function displayResults(analysis) {
            resultsDiv.innerHTML = '';
            const categories = {
                exploits: { title: "Exploits & Red Flags", icon: "🚩", class: "exploit-item" },
                opportunities: { title: "Opportunities & Core Tech", icon: "💡", class: "opportunity-item" },
                gaps: { title: "Knowledge Gaps", icon: "❓", class: "gap-item" },
                models: { title: "Growth Models", icon: "📈", class: "model-item" },
                ethical_concerns: { title: "Ethical Concerns & Bias", icon: "⚖️", class: "ethical-item" },
                reproducibility_issues: { title: "Reproducibility Issues", icon: "🔄", class: "reproducibility-item" }
            };

            for (const key in categories) {
                const category = categories[key];
                const items = analysis[key] || [];
                let itemsHtml = items.length > 0
                    ? items.map(item => formatRankedItem(item, category.class)).join('')
                    : `<p>No significant items found.</p>`;

                const cardHtml = `
                    <div class="result-card">
                        <h3 class="card-title"><span class="card-icon">${category.icon}</span> ${category.title}</h3>
                        ${itemsHtml}
                    </div>
                `;
                resultsDiv.innerHTML += cardHtml;
            }
            resultsDiv.style.display = 'grid';
            document.querySelector('.reset-btn').style.display = 'flex';

            // Generate and display research paper score
            displayResearchScore(analysis);

            // Add search and filter functionality
            setTimeout(() => addSearchAndFilterControls(), 100);
        }

        function calculateResearchScore(analysis) {
            const scoring = {
                methodological_rigor: 0,
                reproducibility: 0,
                ethical_compliance: 0,
                statistical_validity: 0,
                transparency: 0,
                innovation_potential: 0,
                overall_quality: 0
            };

            // Calculate scores based on analysis results
            const exploits = analysis.exploits || [];
            const opportunities = analysis.opportunities || [];
            const gaps = analysis.gaps || [];
            const ethicalConcerns = analysis.ethical_concerns || [];
            const reproducibilityIssues = analysis.reproducibility_issues || [];
            const models = analysis.models || [];

            // Methodological Rigor (0-100) - penalized by exploits and gaps
            const criticalExploits = exploits.filter(item =>
                (typeof item === 'object' && item.status === 'CRITICAL') ||
                (typeof item === 'string' && item.includes('critical'))
            ).length;
            const methodologicalGaps = gaps.filter(item => {
                const content = typeof item === 'object' ? item.finding : item;
                return content.toLowerCase().includes('control') ||
                       content.toLowerCase().includes('methodology') ||
                       content.toLowerCase().includes('sample');
            }).length;
            scoring.methodological_rigor = Math.max(0, 100 - (criticalExploits * 25) - (methodologicalGaps * 15));

            // Reproducibility (0-100) - based on reproducibility issues
            const criticalRepro = reproducibilityIssues.filter(item =>
                (typeof item === 'object' && item.status === 'CRITICAL') ||
                (typeof item === 'string')
            ).length;
            scoring.reproducibility = Math.max(0, 100 - (criticalRepro * 20));

            // Ethical Compliance (0-100) - penalized by ethical concerns
            const criticalEthical = ethicalConcerns.filter(item =>
                (typeof item === 'object' && (item.status === 'CRITICAL' || item.status === 'HIGH')) ||
                (typeof item === 'string')
            ).length;
            scoring.ethical_compliance = Math.max(0, 100 - (criticalEthical * 18));

            // Statistical Validity (0-100) - based on statistical gaps and model quality
            const statisticalIssues = gaps.filter(item => {
                const content = typeof item === 'object' ? item.finding : item;
                return content.toLowerCase().includes('statistical') ||
                       content.toLowerCase().includes('significance') ||
                       content.toLowerCase().includes('p-value');
            }).length;
            scoring.statistical_validity = Math.max(0, 100 - (statisticalIssues * 20));

            // Transparency (0-100) - based on data sharing and openness issues
            const transparencyIssues = reproducibilityIssues.filter(item => {
                const content = typeof item === 'object' ? item.finding : item;
                return content.toLowerCase().includes('data') ||
                       content.toLowerCase().includes('code') ||
                       content.toLowerCase().includes('sharing');
            }).length;
            scoring.transparency = Math.max(0, 100 - (transparencyIssues * 22));

            // Innovation Potential (0-100) - boosted by high-quality opportunities
            const highValueOpportunities = opportunities.filter(item =>
                (typeof item === 'object' && (item.status === 'HIGH' || item.rank <= 2)) ||
                (typeof item === 'string')
            ).length;
            scoring.innovation_potential = Math.min(100, 40 + (highValueOpportunities * 15));

            // Overall Quality (weighted average)
            scoring.overall_quality = Math.round(
                (scoring.methodological_rigor * 0.25) +
                (scoring.reproducibility * 0.20) +
                (scoring.ethical_compliance * 0.15) +
                (scoring.statistical_validity * 0.20) +
                (scoring.transparency * 0.10) +
                (scoring.innovation_potential * 0.10)
            );

            return scoring;
        }

        function displayResearchScore(analysis) {
            const scores = calculateResearchScore(analysis);

            const scoreHtml = `
                <div class="research-score-section">
                    <h3 class="score-title">📊 Research Paper Quality Score</h3>
                    <div class="score-chart">
                        <div class="overall-score">
                            <div class="overall-score-circle ${getScoreClass(scores.overall_quality)}">
                                <span class="score-number">${scores.overall_quality}</span>
                                <span class="score-label">Overall</span>
                            </div>
                        </div>
                        <div class="detailed-scores">
                            ${Object.entries(scores).filter(([key]) => key !== 'overall_quality').map(([key, value]) => `
                                <div class="score-metric">
                                    <div class="metric-label">${formatMetricName(key)}</div>
                                    <div class="metric-bar">
                                        <div class="metric-fill ${getScoreClass(value)}" style="width: ${value}%"></div>
                                        <span class="metric-value">${value}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="score-recommendations">
                        ${generateRecommendations(scores)}
                    </div>
                </div>
            `;

            resultsDiv.innerHTML += scoreHtml;

            // Add export functionality
            addExportButtons();
        }

        function formatMetricName(key) {
            return key.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        }

        function getScoreClass(score) {
            if (score >= 80) return 'score-excellent';
            if (score >= 70) return 'score-good';
            if (score >= 60) return 'score-fair';
            if (score >= 40) return 'score-poor';
            return 'score-critical';
        }

        function generateRecommendations(scores) {
            const recommendations = [];

            if (scores.methodological_rigor < 70) {
                recommendations.push("🔬 <strong>Strengthen methodology:</strong> Add proper control groups, increase sample size, and clarify experimental design.");
            }

            if (scores.reproducibility < 60) {
                recommendations.push("🔄 <strong>Improve reproducibility:</strong> Share code, data, and detailed procedures. Provide clear replication instructions.");
            }

            if (scores.ethical_compliance < 80) {
                recommendations.push("⚖️ <strong>Address ethical concerns:</strong> Implement bias mitigation, ensure diverse datasets, and conduct ethical review.");
            }

            if (scores.statistical_validity < 70) {
                recommendations.push("📈 <strong>Enhance statistical rigor:</strong> Add significance testing, confidence intervals, and effect size reporting.");
            }

            if (scores.transparency < 60) {
                recommendations.push("📊 <strong>Increase transparency:</strong> Make data publicly available, document all analysis steps, and disclose conflicts of interest.");
            }

            if (recommendations.length === 0) {
                recommendations.push("✅ <strong>Excellent work!</strong> This research demonstrates high quality across all evaluation metrics.");
            }

            return recommendations.map(rec => `<div class="recommendation">${rec}</div>`).join('');
        }

        // --- HISTORY & BOOKMARKING FUNCTIONS ---
        function saveToHistory(url, data) {
            const historyItem = {
                id: Date.now().toString(),
                url: url,
                title: extractTitle(data.structuredData || data.sourceText),
                timestamp: new Date().toISOString(),
                overallScore: calculateResearchScore(data.analysis).overall_quality,
                analysis: data.analysis,
                structuredData: data.structuredData,
                sourceText: data.sourceText
            };

            // Add to beginning and limit to 50 items
            analysisHistory.unshift(historyItem);
            analysisHistory = analysisHistory.slice(0, 50);

            localStorage.setItem('analysisHistory', JSON.stringify(analysisHistory));
            updateHistoryDisplay();
        }

        function extractTitle(data) {
            if (Array.isArray(data)) {
                const titleSection = data.find(section => section.section === 'title');
                return titleSection ? titleSection.content.substring(0, 100) : 'Untitled Paper';
            }
            // Extract title from text format
            const titleMatch = data.match(/Title:\s*([^\n]+)/);
            return titleMatch ? titleMatch[1].substring(0, 100) : 'Untitled Paper';
        }

        async function addBookmarkButton() {
            if (!currentAnalysisResult) return;

            // Remove existing bookmark button if present
            const existingBtn = document.querySelector('.bookmark-btn');
            if (existingBtn) {
                existingBtn.remove();
            }

            const bookmarkBtn = document.createElement('button');
            bookmarkBtn.className = 'bookmark-btn';
            const url = urlInput.value.trim();

            // Show loading state initially
            bookmarkBtn.innerHTML = '⏳ Loading...';
            bookmarkBtn.onclick = toggleBookmark;
            bookmarkBtn.style.display = 'flex';

            const resetBtn = document.querySelector('.reset-btn');
            if (resetBtn) {
                resetBtn.parentNode.insertBefore(bookmarkBtn, resetBtn);
            }

            // Update button text asynchronously
            try {
                const isBookmarkedResult = await isBookmarked(url);
                bookmarkBtn.innerHTML = isBookmarkedResult ? '⭐ Bookmarked' : '☆ Bookmark';
            } catch (error) {
                console.error('Error checking bookmark status:', error);
                bookmarkBtn.innerHTML = '☆ Bookmark';
            }
        }

        async function toggleBookmark() {
            if (!currentAnalysisResult) return;

            // Check if user is signed in
            if (!currentUser) {
                showToast('Sign in to bookmark papers across devices!');
                showAuthModal();
                return;
            }

            const url = urlInput.value.trim();
            const bookmarkBtn = document.querySelector('.bookmark-btn');
            if (bookmarkBtn) {
                bookmarkBtn.disabled = true;
                bookmarkBtn.innerHTML = '⏳ Loading...';
            }

            try {
                const { db } = await import('./lib/supabase.js');

                // First, save the analysis if it's not already saved
                let analysisId = currentAnalysisResult.id;
                if (!analysisId) {
                    const analysisData = {
                        url: url,
                        title: extractTitle(currentAnalysisResult.structuredData || currentAnalysisResult.sourceText),
                        analysis: currentAnalysisResult.analysis,
                        structuredData: currentAnalysisResult.structuredData,
                        sourceText: currentAnalysisResult.sourceText,
                        overallScore: calculateResearchScore(currentAnalysisResult.analysis).overall_quality
                    };

                    const { data: savedAnalysis, error: saveError } = await db.saveAnalysis(currentUser.id, analysisData);
                    if (saveError) {
                        throw new Error('Failed to save analysis: ' + saveError.message);
                    }
                    analysisId = savedAnalysis.id;
                    currentAnalysisResult.id = analysisId;
                }

                // Check if already bookmarked
                const { exists } = await db.isBookmarked(currentUser.id, analysisId);

                if (exists) {
                    // Remove bookmark
                    const { error } = await db.removeBookmark(currentUser.id, analysisId);
                    if (error) throw new Error('Failed to remove bookmark: ' + error.message);
                    showToast('Bookmark removed');
                } else {
                    // Add bookmark
                    const bookmarkData = {
                        url: url,
                        title: extractTitle(currentAnalysisResult.structuredData || currentAnalysisResult.sourceText),
                        overallScore: calculateResearchScore(currentAnalysisResult.analysis).overall_quality
                    };

                    const { error } = await db.saveBookmark(currentUser.id, analysisId, bookmarkData);
                    if (error) throw new Error('Failed to save bookmark: ' + error.message);
                    showToast('Paper bookmarked!');
                }

                updateBookmarkButton();
                updateHistoryDisplay();

            } catch (error) {
                console.error('Bookmark toggle error:', error);
                showToast('Error updating bookmark: ' + error.message, true);

                // Fallback to localStorage for offline mode
                toggleBookmarkLocalStorage();
            } finally {
                if (bookmarkBtn) {
                    bookmarkBtn.disabled = false;
                }
            }
        }

        function toggleBookmarkLocalStorage() {
            // Fallback localStorage implementation
            const url = urlInput.value.trim();
            const isCurrentlyBookmarked = bookmarkedPapers.some(item => item.url === url);

            if (isCurrentlyBookmarked) {
                bookmarkedPapers = bookmarkedPapers.filter(item => item.url !== url);
                showToast('Bookmark removed (offline)');
            } else {
                // Auto-generate categories/tags based on content
                const title = extractTitle(currentAnalysisResult.structuredData || currentAnalysisResult.sourceText);
                const content = JSON.stringify(currentAnalysisResult.analysis || {}).toLowerCase();
                const categories = autoCategorizePaper(title, content);

                const bookmarkItem = {
                    id: Date.now().toString(),
                    url: url,
                    title: title,
                    timestamp: new Date().toISOString(),
                    overallScore: calculateResearchScore(currentAnalysisResult.analysis).overall_quality,
                    categories: categories,
                    tags: generateTags(title, content)
                };
                bookmarkedPapers.unshift(bookmarkItem);
                showToast('Paper bookmarked (offline)');
            }

            localStorage.setItem('bookmarkedPapers', JSON.stringify(bookmarkedPapers));
            updateBookmarkButton();
            updateHistoryDisplay();
        }

        async function isBookmarked(url) {
            // If user is signed in, check Supabase
            if (currentUser && currentAnalysisResult?.id) {
                try {
                    const { db } = await import('./lib/supabase.js');
                    const { exists } = await db.isBookmarked(currentUser.id, currentAnalysisResult.id);
                    return exists;
                } catch (error) {
                    console.error('Error checking bookmark status:', error);
                    // Fallback to localStorage
                }
            }

            // Fallback to localStorage
            return bookmarkedPapers.some(item => item.url === url);
        }

        function autoCategorizePaper(title, content) {
            const categories = [];
            const titleLower = (title || '').toLowerCase();
            const contentLower = content.toLowerCase();

            // Define category keywords
            const categoryMap = {
                'Machine Learning': ['machine learning', 'ml', 'neural', 'deep learning', 'ai', 'artificial intelligence', 'model', 'training', 'algorithm'],
                'Education': ['education', 'teaching', 'learning', 'student', 'curriculum', 'pedagogy', 'academic'],
                'Cryptography': ['cryptography', 'encryption', 'crypto', 'security', 'hash', 'blockchain', 'cipher'],
                'Medicine': ['medical', 'medicine', 'health', 'clinical', 'patient', 'treatment', 'therapy'],
                'Computer Science': ['computer', 'software', 'programming', 'system', 'database', 'computing'],
                'Physics': ['physics', 'quantum', 'particle', 'energy', 'theory', 'experiment'],
                'Biology': ['biology', 'biological', 'cell', 'gene', 'protein', 'dna', 'molecular'],
                'Mathematics': ['mathematics', 'mathematical', 'theorem', 'proof', 'equation', 'analysis']
            };

            // Check for category matches
            for (const [category, keywords] of Object.entries(categoryMap)) {
                const hasMatch = keywords.some(keyword =>
                    titleLower.includes(keyword) || contentLower.includes(keyword)
                );
                if (hasMatch) {
                    categories.push(category);
                }
            }

            // Default category if none found
            if (categories.length === 0) {
                categories.push('Other');
            }

            return categories;
        }

        function generateTags(title, content) {
            const tags = new Set();
            const text = ((title || '') + ' ' + content).toLowerCase();

            // Common research tags
            const tagKeywords = [
                'survey', 'review', 'systematic', 'meta-analysis', 'empirical', 'experimental',
                'theoretical', 'novel', 'approach', 'framework', 'methodology', 'algorithm',
                'analysis', 'evaluation', 'comparison', 'performance', 'optimization',
                'deep', 'neural', 'network', 'learning', 'supervised', 'unsupervised',
                'classification', 'prediction', 'regression', 'clustering', 'detection'
            ];

            tagKeywords.forEach(keyword => {
                if (text.includes(keyword)) {
                    tags.add(keyword);
                }
            });

            return Array.from(tags).slice(0, 8); // Limit to 8 tags
        }

        async function updateBookmarkButton() {
            const bookmarkBtn = document.querySelector('.bookmark-btn');
            if (bookmarkBtn && currentAnalysisResult) {
                const url = urlInput.value.trim();
                const isBookmarkedResult = await isBookmarked(url);
                bookmarkBtn.innerHTML = isBookmarkedResult ? '⭐ Bookmarked' : '☆ Bookmark';
            }
        }

        function updateHistoryDisplay() {
            // This will be called when we add the history sidebar
        }

        // --- SEARCH & FILTER FUNCTIONS ---
        function addSearchAndFilterControls() {
            // Remove existing search controls if present
            const existingControls = document.querySelector('.search-controls');
            if (existingControls) {
                existingControls.remove();
            }

            const searchControlsHtml = `
                <div class="search-controls">
                    <div class="search-bar">
                        <input type="text" id="searchInput" placeholder="Search findings..." class="search-input" onkeyup="if(event.key==='Enter') searchResults()">
                        <button onclick="searchResults()" class="search-btn">🔍</button>
                    </div>
                    <div class="filter-controls">
                        <select id="statusFilter" class="filter-select" onchange="filterResults()">
                            <option value="">All Status</option>
                            <option value="CRITICAL">Critical</option>
                            <option value="HIGH">High</option>
                            <option value="MODERATE">Moderate</option>
                            <option value="LOW">Low</option>
                        </select>
                        <select id="rankFilter" class="filter-select" onchange="filterResults()">
                            <option value="">All Ranks</option>
                            <option value="1">Rank 1</option>
                            <option value="2">Rank 2</option>
                            <option value="3">Rank 3</option>
                            <option value="4">Rank 4</option>
                            <option value="5">Rank 5</option>
                        </select>
                        <select id="categoryFilter" class="filter-select" onchange="filterResults()">
                            <option value="">All Categories</option>
                            <option value="exploits">Exploits</option>
                            <option value="opportunities">Opportunities</option>
                            <option value="gaps">Gaps</option>
                            <option value="models">Models</option>
                            <option value="ethical_concerns">Ethical Concerns</option>
                            <option value="reproducibility_issues">Reproducibility</option>
                        </select>
                        <button onclick="clearFilters()" class="clear-filters-btn">Clear Filters</button>
                    </div>
                </div>
            `;

            // Insert search controls before the results
            resultsDiv.insertAdjacentHTML('beforebegin', searchControlsHtml);
        }

        function searchResults() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const resultCards = document.querySelectorAll('.result-card');

            resultCards.forEach(card => {
                const cardText = card.textContent.toLowerCase();
                const shouldShow = searchTerm === '' || cardText.includes(searchTerm);
                card.style.display = shouldShow ? 'block' : 'none';
            });

            // Also search within individual items
            const rankedItems = document.querySelectorAll('.ranked-item');
            rankedItems.forEach(item => {
                const itemText = item.textContent.toLowerCase();
                const shouldShow = searchTerm === '' || itemText.includes(searchTerm);
                item.style.display = shouldShow ? 'block' : 'none';
            });
        }

        function filterResults() {
            const statusFilter = document.getElementById('statusFilter')?.value || '';
            const rankFilter = document.getElementById('rankFilter')?.value || '';
            const categoryFilter = document.getElementById('categoryFilter')?.value || '';

            const resultCards = document.querySelectorAll('.result-card');

            resultCards.forEach(card => {
                let shouldShowCard = true;

                // Category filter
                if (categoryFilter) {
                    const cardTitle = card.querySelector('.card-title')?.textContent.toLowerCase() || '';
                    const categoryMatch = {
                        'exploits': cardTitle.includes('exploits'),
                        'opportunities': cardTitle.includes('opportunities'),
                        'gaps': cardTitle.includes('gaps'),
                        'models': cardTitle.includes('models'),
                        'ethical_concerns': cardTitle.includes('ethical'),
                        'reproducibility_issues': cardTitle.includes('reproducibility')
                    };
                    shouldShowCard = categoryMatch[categoryFilter] || false;
                }

                if (shouldShowCard) {
                    card.style.display = 'block';

                    // Filter individual items within visible cards
                    const rankedItems = card.querySelectorAll('.ranked-item');
                    rankedItems.forEach(item => {
                        let shouldShowItem = true;

                        // Status filter
                        if (statusFilter) {
                            const statusBadge = item.querySelector('.status-badge');
                            shouldShowItem = statusBadge && statusBadge.textContent === statusFilter;
                        }

                        // Rank filter
                        if (shouldShowItem && rankFilter) {
                            const rankBadge = item.querySelector('.rank-badge');
                            shouldShowItem = rankBadge && rankBadge.textContent.includes(`#${rankFilter}`);
                        }

                        item.style.display = shouldShowItem ? 'block' : 'none';
                    });
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('rankFilter').value = '';
            document.getElementById('categoryFilter').value = '';

            // Show all items
            const allCards = document.querySelectorAll('.result-card');
            const allItems = document.querySelectorAll('.ranked-item');

            allCards.forEach(card => card.style.display = 'block');
            allItems.forEach(item => item.style.display = 'block');
        }

        // --- EXPORT FUNCTIONALITY ---
        function addExportButtons() {
            // Remove existing export controls if present
            const existingControls = document.querySelector('.export-controls');
            if (existingControls) {
                existingControls.remove();
            }

            const exportControlsHtml = `
                <div class="export-controls">
                    <h3>📊 Export Options</h3>
                    <div class="export-buttons">
                        <button onclick="exportToCSV()" class="export-btn csv-btn">📄 Export CSV</button>
                        <button onclick="exportToPDF()" class="export-btn pdf-btn">📑 Export PDF</button>
                        <button onclick="exportToJSON()" class="export-btn json-btn">💾 Export JSON</button>
                        <button onclick="copyToClipboard()" class="export-btn copy-btn">📋 Copy Text</button>
                    </div>
                </div>
            `;

            resultsDiv.insertAdjacentHTML('afterend', exportControlsHtml);
        }

        function exportToCSV() {
            if (!currentAnalysisResult) {
                showToast('No analysis data to export', true);
                return;
            }

            const analysis = currentAnalysisResult.analysis;
            const scores = calculateResearchScore(analysis);
            let csvContent = 'Category,Rank,Status,Tags,Finding,Score\n';

            // Add all findings
            Object.entries(analysis).forEach(([category, items]) => {
                if (Array.isArray(items)) {
                    items.forEach(item => {
                        if (typeof item === 'object') {
                            const finding = (item.finding || '').replace(/"/g, '""');
                            const tags = Array.isArray(item.tags) ? item.tags.join(';') : '';
                            csvContent += `"${category}","${item.rank || ''}","${item.status || ''}","${tags}","${finding}",""\n`;
                        } else {
                            csvContent += `"${category}","","","","${item.replace(/"/g, '""')}",""\n`;
                        }
                    });
                }
            });

            // Add scores
            csvContent += '\nScoring Metrics,,,,,\n';
            Object.entries(scores).forEach(([metric, score]) => {
                csvContent += `"${formatMetricName(metric)}","","","","","${score}"\n`;
            });

            downloadFile(csvContent, 'research-analysis.csv', 'text/csv');
        }

        function exportToPDF() {
            // For now, create a formatted text version that can be converted to PDF
            if (!currentAnalysisResult) {
                showToast('No analysis data to export', true);
                return;
            }

            const analysis = currentAnalysisResult.analysis;
            const scores = calculateResearchScore(analysis);
            const title = extractTitle(currentAnalysisResult.structuredData || currentAnalysisResult.sourceText);

            let pdfContent = `RESEARCH PAPER ANALYSIS REPORT\n`;
            pdfContent += `${'='.repeat(50)}\n\n`;
            pdfContent += `Paper: ${title}\n`;
            pdfContent += `Analysis Date: ${new Date().toLocaleDateString()}\n`;
            pdfContent += `Overall Quality Score: ${scores.overall_quality}/100\n\n`;

            // Add detailed scores
            pdfContent += `QUALITY METRICS:\n`;
            pdfContent += `${'-'.repeat(20)}\n`;
            Object.entries(scores).filter(([key]) => key !== 'overall_quality').forEach(([metric, score]) => {
                pdfContent += `${formatMetricName(metric)}: ${score}/100\n`;
            });

            // Add findings by category
            Object.entries(analysis).forEach(([category, items]) => {
                if (Array.isArray(items) && items.length > 0) {
                    pdfContent += `\n${category.toUpperCase().replace('_', ' ')}:\n`;
                    pdfContent += `${'-'.repeat(30)}\n`;

                    items.forEach((item, index) => {
                        if (typeof item === 'object') {
                            pdfContent += `${index + 1}. [Rank ${item.rank || 'N/A'}] [${item.status || 'N/A'}] `;
                            pdfContent += `${item.finding || item}\n\n`;
                        } else {
                            pdfContent += `${index + 1}. ${item}\n\n`;
                        }
                    });
                }
            });

            downloadFile(pdfContent, 'research-analysis.txt', 'text/plain');
            showToast('Text report exported! Use a PDF converter for final PDF format.');
        }

        function exportToJSON() {
            if (!currentAnalysisResult) {
                showToast('No analysis data to export', true);
                return;
            }

            const exportData = {
                metadata: {
                    exportDate: new Date().toISOString(),
                    paperTitle: extractTitle(currentAnalysisResult.structuredData || currentAnalysisResult.sourceText),
                    url: urlInput.value.trim()
                },
                scores: calculateResearchScore(currentAnalysisResult.analysis),
                analysis: currentAnalysisResult.analysis,
                structuredData: currentAnalysisResult.structuredData,
                sourceText: currentAnalysisResult.sourceText
            };

            const jsonContent = JSON.stringify(exportData, null, 2);
            downloadFile(jsonContent, 'research-analysis.json', 'application/json');
        }

        function copyToClipboard() {
            if (!currentAnalysisResult) {
                showToast('No analysis data to copy', true);
                return;
            }

            const analysis = currentAnalysisResult.analysis;
            const scores = calculateResearchScore(analysis);
            const title = extractTitle(currentAnalysisResult.structuredData || currentAnalysisResult.sourceText);

            let clipboardContent = `Research Paper Analysis: ${title}\n`;
            clipboardContent += `Overall Quality Score: ${scores.overall_quality}/100\n\n`;

            // Add key findings summary
            Object.entries(analysis).forEach(([category, items]) => {
                if (Array.isArray(items) && items.length > 0) {
                    clipboardContent += `${category.toUpperCase().replace('_', ' ')} (${items.length} items):\n`;
                    const topItems = items.slice(0, 3);
                    topItems.forEach((item, index) => {
                        const content = typeof item === 'object' ? (item.finding || item) : item;
                        clipboardContent += `  ${index + 1}. ${content.substring(0, 150)}...\n`;
                    });
                    clipboardContent += '\n';
                }
            });

            navigator.clipboard.writeText(clipboardContent).then(() => {
                showToast('Analysis summary copied to clipboard!');
            }).catch(() => {
                showToast('Failed to copy to clipboard', true);
            });
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast(`${filename} downloaded successfully!`);
        }

        function displaySourceText(data) {
            if (Array.isArray(data)) {
                // Display structured JSON format
                const formattedHTML = formatStructuredData(data);
                sourceTextContent.innerHTML = formattedHTML;
            } else {
                // Display traditional text format
                const formattedText = formatSourceText(data);
                sourceTextContent.innerHTML = formattedText;
            }
            sourceTextSection.style.display = 'block';
        }

        function formatStructuredData(structuredData) {
            let html = '<div class="structured-data">';

            structuredData.forEach(section => {
                html += `<div class="json-section">`;
                html += `<div class="json-section-title">${section.section.charAt(0).toUpperCase() + section.section.slice(1).replace('_', ' ')}</div>`;
                html += `<div class="json-section-content">`;

                if (typeof section.content === 'string') {
                    html += `<p>${section.content}</p>`;
                } else if (Array.isArray(section.content)) {
                    html += '<ul>';
                    section.content.forEach(item => {
                        html += `<li>${item}</li>`;
                    });
                    html += '</ul>';
                } else if (typeof section.content === 'object') {
                    html += '<div class="json-object">';
                    for (const [key, value] of Object.entries(section.content)) {
                        html += `<div class="json-key-value">`;
                        html += `<span class="json-key">${key}:</span> `;
                        if (Array.isArray(value)) {
                            html += '<ul>';
                            value.forEach(item => {
                                html += `<li>${item}</li>`;
                            });
                            html += '</ul>';
                        } else {
                            html += `<span class="json-value">${value}</span>`;
                        }
                        html += '</div>';
                    }
                    html += '</div>';
                }

                html += '</div></div>';
            });

            html += '</div>';
            return html;
        }

        function formatSourceText(text) {
            // Replace patterns for common research paper sections with bolded titles
            let formatted = text
                .replace(/^Title:\s*/gmi, '<strong>Title:</strong> ')
                .replace(/^Authors?:\s*/gmi, '<strong>Authors:</strong> ')
                .replace(/^Abstract:\s*/gmi, '<strong>Abstract:</strong> ')
                .replace(/^Full Content:\s*/gmi, '<strong>Full Content:</strong> ')
                .replace(/^Introduction:\s*/gmi, '<strong>Introduction:</strong> ')
                .replace(/^Methodology:\s*/gmi, '<strong>Methodology:</strong> ')
                .replace(/^Results:\s*/gmi, '<strong>Results:</strong> ')
                .replace(/^Discussion:\s*/gmi, '<strong>Discussion:</strong> ')
                .replace(/^Conclusion:\s*/gmi, '<strong>Conclusion:</strong> ')
                .replace(/^References:\s*/gmi, '<strong>References:</strong> ');

            // Convert line breaks to HTML
            formatted = formatted.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>');

            // Wrap in paragraph tags if not already wrapped
            if (!formatted.startsWith('<p>')) {
                formatted = '<p>' + formatted + '</p>';
            }

            return formatted;
        }

        function toggleSourceText() {
            const content = sourceTextContent;
            const arrow = document.getElementById('sourceTextArrow');

            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                content.classList.add('expanded');
                arrow.classList.add('expanded');
            } else {
                content.classList.remove('expanded');
                content.classList.add('collapsed');
                arrow.classList.remove('expanded');
            }
        }

        // --- UTILITY & HELPER FUNCTIONS ---
        function showToast(message, isError = false) {
            const toast = document.createElement('div');
            toast.className = `toast ${isError ? 'error' : ''}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => { toast.classList.add('show'); }, 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 4000);
        }

        function updateLoadingText(text) {
            document.getElementById('loadingText').textContent = text;
        }

        function resetUI(isLoading = false) {
            resultsDiv.style.display = 'none';
            blueprintSection.style.display = 'none';
            sourceTextSection.style.display = 'none';
            errorDiv.textContent = '';
            loadingDiv.style.display = isLoading ? 'block' : 'none';

            // Reset progress tracking
            if (!isLoading) {
                stopProgressTracking();
            }

            // Clean up new elements
            const searchControls = document.querySelector('.search-controls');
            if (searchControls) searchControls.remove();

            const exportControls = document.querySelector('.export-controls');
            if (exportControls) exportControls.remove();

            const bookmarkBtn = document.querySelector('.bookmark-btn');
            if (bookmarkBtn) bookmarkBtn.style.display = 'none';

            if (!isLoading) {
                urlInput.value = '';
                document.querySelector('.reset-btn').style.display = 'none';
                currentAnalysisResult = null;
            }
        }

        function loadRandomExample() {
            const examples = [
                { url: 'https://arxiv.org/abs/2307.12008' },
                { url: 'https://arxiv.org/abs/2409.02098' },
                { url: 'https://arxiv.org/abs/2303.08774' }
            ];
            const randomExample = examples[Math.floor(Math.random() * examples.length)];
            urlInput.value = randomExample.url;
            showToast('Random arXiv abstract URL loaded. Click "Analyze" to proceed.');
        }

        function highlightTextInString(text) {
            if (!currentAnalysisResult || !currentAnalysisResult.sourceText) return text;
            const keywords = text.match(/"(.*?)"/g);
            if (!keywords) return text;

            const keyword = keywords[0].replace(/"/g, '');
            return `${text} <a href="#sourceTextSection" onclick="event.preventDefault(); scrollToHighlight('${keyword.replace(/'/g, "\\'")}')" class="context-link">(See context)</a>`;
        }

        function scrollToHighlight(keyword) {
            const contentEl = sourceTextContent;
            const originalHTML = contentEl.innerHTML;

            // Expand the dropdown if it's collapsed
            if (contentEl.classList.contains('collapsed')) {
                toggleSourceText();
            }

            const regex = new RegExp(keyword.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'gi');
            contentEl.innerHTML = originalHTML.replace(regex, `<mark class="flash-highlight">$&</mark>`);

            const mark = contentEl.querySelector('mark');
            if (mark) {
                mark.scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(() => { contentEl.innerHTML = originalHTML; }, 2000);
            } else {
                contentEl.innerHTML = originalHTML;
            }
        }

        function generateBlueprint() {
            if (!currentAnalysisResult) return;
            const { analysis } = currentAnalysisResult;
            const opportunities = analysis.opportunities || [];
            const gaps = analysis.gaps || [];
            const exploits = analysis.exploits || [];

            // Extract content from new object format or fallback to string format
            const getContent = (item) => {
                if (typeof item === 'string') return item;
                return item.finding || item.content || '';
            };

            const primaryGap = gaps.length > 0 ? getContent(gaps[0]) : 'Lack of verifiable data';
            const primaryOpportunity = opportunities.length > 0 ? getContent(opportunities[0]) : 'The underlying scientific principle';

            // Get top 3 highest priority issues from exploits for MVP focus
            const sortedExploits = exploits.filter(item => typeof item === 'object' && item.rank)
                .sort((a, b) => a.rank - b.rank)
                .slice(0, 3);

            let blueprintText = `
Project Blueprint: A Legitimate MVP Approach
============================================

Based on the analysis, here is a potential roadmap to build a Minimum Viable Product (MVP) that addresses the identified gaps and leverages the core opportunities while avoiding the exploits found.

1. Core Problem to Solve:
-------------------------
Address the primary knowledge gap: "${primaryGap.substring(0, 200)}...".

2. Key Technology/Principle to Use:
-----------------------------------
Focus on the core legitimate opportunity: "${primaryOpportunity.substring(0, 200)}...".

3. Critical Issues to Avoid:
----------------------------`;

            if (sortedExploits.length > 0) {
                sortedExploits.forEach((exploit, index) => {
                    blueprintText += `\n* Issue #${exploit.rank}: ${getContent(exploit).substring(0, 150)}...`;
                });
            } else {
                blueprintText += `\n* Ensure all claims are backed by verifiable data\n* Implement proper peer review processes\n* Avoid overstated conclusions`;
            }

            blueprintText += `

4. Proposed MVP Features:
-------------------------
* A public data dashboard to transparently display experimental results.
* An open-source simulation model of the core scientific mechanism.
* A peer-review submission portal to gather external validation.
* Clear, documented methodology for replication.
* Bias detection and mitigation tools based on ethical concerns identified.

5. Key Metrics for Success:
---------------------------
* Number of successful, independent replications of the core result.
* Correlation factor between simulation and real-world experimental data.
* Number of positive peer reviews received through the portal.
* Ethical compliance score based on identified concerns.
            `;
            blueprintContent.textContent = blueprintText.trim();
            blueprintSection.style.display = 'block';
            blueprintSection.scrollIntoView({ behavior: 'smooth' });
        }

        function downloadBlueprint() {
            if (!blueprintContent.textContent) {
                showToast('No blueprint to download.', true);
                return;
            }
            const blob = new Blob([blueprintContent.textContent], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'mvp-blueprint.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Form submission handler
        analyzeForm.addEventListener('submit', (e) => {
            e.preventDefault();
            analyzeCase();
        });

        // Authentication state management
        let currentUser = null;
        let authModal = null;
        let userMenu = null;

        // Initialize authentication on page load
        // Progress tracking variables
        let progressInterval = null;
        let progressStartTime = null;
        let currentProgress = 0;

        function startProgressTracking() {
            progressStartTime = Date.now();
            currentProgress = 0;

            const progressFill = document.getElementById('progressFill');
            const progressPercentage = document.getElementById('progressPercentage');
            const timeRemaining = document.getElementById('timeRemaining');

            // Reset progress
            progressFill.style.width = '0%';
            progressPercentage.textContent = '0%';
            timeRemaining.textContent = 'Estimating time...';

            // Start progress simulation
            progressInterval = setInterval(() => {
                const elapsed = (Date.now() - progressStartTime) / 1000; // seconds

                // Simulate realistic progress curve (starts fast, slows down)
                if (currentProgress < 20) {
                    currentProgress += Math.random() * 4 + 2; // 2-6% per second initially
                } else if (currentProgress < 60) {
                    currentProgress += Math.random() * 2 + 1; // 1-3% per second
                } else if (currentProgress < 90) {
                    currentProgress += Math.random() * 1 + 0.5; // 0.5-1.5% per second
                } else {
                    currentProgress += Math.random() * 0.3; // Very slow near end
                }

                currentProgress = Math.min(currentProgress, 95); // Never reach 100% until completion

                // Update UI
                progressFill.style.width = currentProgress + '%';
                progressPercentage.textContent = Math.floor(currentProgress) + '%';

                // Estimate time remaining (rough approximation)
                if (elapsed > 3 && currentProgress > 10) {
                    const estimatedTotal = (elapsed / currentProgress) * 100;
                    const remaining = Math.max(0, estimatedTotal - elapsed);

                    if (remaining > 60) {
                        timeRemaining.textContent = `~${Math.ceil(remaining / 60)}m remaining`;
                    } else if (remaining > 0) {
                        timeRemaining.textContent = `~${Math.ceil(remaining)}s remaining`;
                    } else {
                        timeRemaining.textContent = 'Almost done...';
                    }
                } else {
                    timeRemaining.textContent = 'Estimating time...';
                }

                // Update loading text based on progress
                if (currentProgress < 30) {
                    updateLoadingText('🔍 Fetching research paper content...');
                } else if (currentProgress < 70) {
                    updateLoadingText('🧠 Analyzing with AI models...');
                } else if (currentProgress < 90) {
                    updateLoadingText('⚡ Generating insights and rankings...');
                } else {
                    updateLoadingText('✨ Finalizing analysis results...');
                }

            }, 500); // Update every 500ms
        }

        function completeProgress() {
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }

            // Instantly complete progress
            currentProgress = 100;
            const progressFill = document.getElementById('progressFill');
            const progressPercentage = document.getElementById('progressPercentage');
            const timeRemaining = document.getElementById('timeRemaining');

            progressFill.style.width = '100%';
            progressPercentage.textContent = '100%';
            timeRemaining.textContent = 'Complete!';
            updateLoadingText('🎉 Analysis complete!');
        }

        function stopProgressTracking() {
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }

            // Reset progress
            currentProgress = 0;
            const progressFill = document.getElementById('progressFill');
            const progressPercentage = document.getElementById('progressPercentage');
            const timeRemaining = document.getElementById('timeRemaining');

            progressFill.style.width = '0%';
            progressPercentage.textContent = '0%';
            timeRemaining.textContent = 'Ready';
        }

        // Test function for debugging navigation
        window.testNavigation = function(pageName) {
            console.log('Testing navigation to:', pageName);
            navigateToPage(pageName);
        };

        // Add temporary debug buttons for testing navigation
        function addDebugNavigationButtons() {
            const debugContainer = document.createElement('div');
            debugContainer.id = 'debug-nav-container';
            debugContainer.style.cssText = `
                position: fixed;
                top: 10px;
                left: 10px;
                z-index: 99999;
                background: rgba(0,0,0,0.8);
                color: white;
                padding: 10px;
                border-radius: 5px;
                font-family: monospace;
                font-size: 12px;
            `;
            debugContainer.innerHTML = `
                <div style="margin-bottom: 5px;">Debug Navigation:</div>
                <button onclick="navigateToPage('main')" style="margin: 2px; padding: 5px;">Main</button>
                <button onclick="navigateToPage('dashboard')" style="margin: 2px; padding: 5px;">Dashboard</button>
                <button onclick="navigateToPage('bookmarks')" style="margin: 2px; padding: 5px;">Bookmarks</button>
                <button onclick="navigateToPage('settings')" style="margin: 2px; padding: 5px;">Settings</button>
                <button onclick="document.getElementById('debug-nav-container').remove()" style="margin: 2px; padding: 5px; background: red;">Remove</button>
            `;
            document.body.appendChild(debugContainer);
        }

        // Remove debug buttons - navigation is working
        // window.addEventListener('load', () => {
        //     setTimeout(addDebugNavigationButtons, 1000);
        // });

        document.addEventListener('DOMContentLoaded', async () => {
            setupCarousel();
            await initializeAuth();
        });

        async function initializeAuth() {
            try {
                // Import Supabase modules
                const { supabase, auth, db, migration } = await import('./lib/supabase.js');

                // Check for existing session
                const { user } = await auth.getCurrentUser();
                if (user) {
                    currentUser = user;
                    renderUserMenu();

                    // Try to migrate localStorage data on first login
                    const hasExistingData = localStorage.getItem('bookmarkedPapers') || localStorage.getItem('analysisHistory');
                    if (hasExistingData) {
                        const { migratedCount } = await migration.migrateLocalStorageData(user.id);
                        if (migratedCount > 0) {
                            showToast(`Successfully migrated ${migratedCount} analyses from local storage!`);
                        }
                    }
                } else {
                    renderSignInButton();
                }

                // Listen for auth state changes
                auth.onAuthStateChange((event, session) => {
                    if (event === 'SIGNED_IN' && session?.user) {
                        currentUser = session.user;
                        renderUserMenu();
                        if (authModal) {
                            authModal.style.display = 'none';
                        }
                    } else if (event === 'SIGNED_OUT') {
                        currentUser = null;
                        renderSignInButton();
                    }
                });

            } catch (error) {
                console.error('Failed to initialize authentication:', error);
                // Fallback to localStorage mode
                renderSignInButton();
            }
        }

        function renderSignInButton() {
            const signInHTML = `
                <button onclick="showAuthModal()" class="auth-signin-btn">
                    🔐 Sign In
                </button>
            `;

            // Update all auth containers
            const containers = ['authContainer', 'authContainerDashboard', 'authContainerBookmarks', 'authContainerSettings'];
            containers.forEach(containerId => {
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = signInHTML;
                }
            });
        }

        function renderUserMenu() {
            if (!currentUser) return;

            const userMenuHTML = `
                <div class="user-menu">
                    <button onclick="toggleUserMenu()" class="user-menu-button" id="userMenuButton">
                        <div class="user-avatar">
                            ${(currentUser.user_metadata?.name?.charAt(0) || currentUser.email.charAt(0)).toUpperCase()}
                        </div>
                        <span class="user-name">
                            ${currentUser.user_metadata?.name || 'User'}
                        </span>
                        <span class="dropdown-arrow">▼</span>
                    </button>
                </div>
            `;

            // Update all auth containers
            const containers = ['authContainer', 'authContainerDashboard', 'authContainerBookmarks', 'authContainerSettings'];
            containers.forEach(containerId => {
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = userMenuHTML;
                }
            });
        }

        function showAuthModal() {
            if (authModal) {
                authModal.style.display = 'block';
                // Reset to sign-in mode when reopening
                resetToSignInMode();
                return;
            }

            // Create auth modal
            const modalHtml = `
                <div class="auth-modal-overlay" id="authModal">
                    <div class="auth-modal">
                        <div class="auth-header">
                            <h2 id="authTitle">Sign In</h2>
                            <button onclick="hideAuthModal()" class="close-btn">×</button>
                        </div>

                        <div class="auth-benefits">
                            <h3>🔄 Sync Your Research Across Devices</h3>
                            <ul>
                                <li>✅ Access bookmarks on any device</li>
                                <li>✅ Never lose your analysis history</li>
                                <li>✅ Personal research dashboard</li>
                                <li>✅ Advanced analytics & insights</li>
                            </ul>
                        </div>

                        <form onsubmit="handleAuthSubmit(event)" class="auth-form" id="authForm">
                            <input type="text" id="authName" placeholder="Your name" class="auth-input" style="display: none;">
                            <input type="email" id="authEmail" placeholder="Email address" required class="auth-input">
                            <input type="password" id="authPassword" placeholder="Password" required minlength="6" class="auth-input">

                            <div class="auth-error" id="authError" style="display: none;"></div>

                            <button type="submit" class="auth-submit" id="authSubmit">
                                Sign In
                            </button>
                        </form>

                        <div class="auth-switch">
                            <p id="authSwitch">
                                Don't have an account?
                                <button onclick="toggleAuthMode()" class="auth-link" id="authSwitchBtn">
                                    Sign up
                                </button>
                            </p>
                        </div>

                        <div class="auth-footer">
                            <p class="privacy-note">
                                🔒 Your data is encrypted and secure. We never share your research data.
                            </p>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
            authModal = document.getElementById('authModal');
        }

        function hideAuthModal() {
            if (authModal) {
                authModal.style.display = 'none';
            }
        }

        let authMode = 'signin';

        function resetToSignInMode() {
            authMode = 'signin';
            const title = document.getElementById('authTitle');
            const nameInput = document.getElementById('authName');
            const submitBtn = document.getElementById('authSubmit');
            const switchText = document.getElementById('authSwitch');
            const switchBtn = document.getElementById('authSwitchBtn');

            if (title) title.textContent = 'Sign In';
            if (nameInput) {
                nameInput.style.display = 'none';
                nameInput.required = false;
            }
            if (submitBtn) submitBtn.textContent = 'Sign In';
            if (switchText) switchText.innerHTML = "Don't have an account? ";
            if (switchBtn) switchBtn.textContent = 'Sign up';

            // Clear form
            const emailInput = document.getElementById('authEmail');
            const passwordInput = document.getElementById('authPassword');
            const errorDiv = document.getElementById('authError');

            if (emailInput) emailInput.value = '';
            if (passwordInput) passwordInput.value = '';
            if (nameInput) nameInput.value = '';
            if (errorDiv) errorDiv.style.display = 'none';
        }

        function toggleAuthMode() {
            authMode = authMode === 'signin' ? 'signup' : 'signin';

            const title = document.getElementById('authTitle');
            const nameInput = document.getElementById('authName');
            const submitBtn = document.getElementById('authSubmit');
            const switchText = document.getElementById('authSwitch');
            const switchBtn = document.getElementById('authSwitchBtn');

            if (authMode === 'signup') {
                title.textContent = 'Create Account';
                nameInput.style.display = 'block';
                nameInput.required = true;
                submitBtn.textContent = 'Create Account';
                switchText.innerHTML = 'Already have an account? ';
                switchBtn.textContent = 'Sign in';
            } else {
                title.textContent = 'Sign In';
                nameInput.style.display = 'none';
                nameInput.required = false;
                submitBtn.textContent = 'Sign In';
                switchText.innerHTML = "Don't have an account? ";
                switchBtn.textContent = 'Sign up';
            }
        }

        async function handleAuthSubmit(event) {
            event.preventDefault();

            const submitBtn = document.getElementById('authSubmit');
            const errorDiv = document.getElementById('authError');
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            const name = document.getElementById('authName').value;

            submitBtn.textContent = 'Loading...';
            submitBtn.disabled = true;
            errorDiv.style.display = 'none';

            try {
                const { auth } = await import('./lib/supabase.js');

                let result;
                if (authMode === 'signup') {
                    result = await auth.signUp(email, password, { name });
                    if (result.data.user && !result.error) {
                        showToast('Check your email for the confirmation link!');
                        hideAuthModal();
                        return;
                    }
                } else {
                    result = await auth.signIn(email, password);
                    if (result.data.user && !result.error) {
                        hideAuthModal();
                        return;
                    }
                }

                if (result.error) {
                    errorDiv.textContent = result.error.message;
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = 'An unexpected error occurred';
                errorDiv.style.display = 'block';
            } finally {
                submitBtn.textContent = authMode === 'signin' ? 'Sign In' : 'Create Account';
                submitBtn.disabled = false;
            }
        }

        let userDropdown = null;

        function toggleUserMenu() {
            console.log('toggleUserMenu called');

            // If dropdown exists, remove it
            if (userDropdown) {
                console.log('Removing existing dropdown');
                document.body.removeChild(userDropdown);
                userDropdown = null;
                return;
            }

            // Create dropdown and append to body to avoid clipping
            userDropdown = document.createElement('div');
            userDropdown.id = 'userMenuDropdown';
            userDropdown.className = 'user-menu-dropdown-portal';
            userDropdown.innerHTML = `
                <div class="user-info">
                    <strong>${currentUser.user_metadata?.name || 'User'}</strong>
                    <small>${currentUser.email}</small>
                </div>
                <hr />
                <button class="menu-item" data-action="dashboard">
                    📊 Dashboard
                </button>
                <button class="menu-item" data-action="bookmarks">
                    ⭐ Bookmarks
                </button>
                <button class="menu-item" data-action="settings">
                    ⚙️ Settings
                </button>
                <hr />
                <button class="menu-item sign-out" data-action="signout">
                    🚪 Sign Out
                </button>
            `;

            // Position dropdown relative to user menu button
            const userMenuButton = document.getElementById('userMenuButton');
            if (userMenuButton) {
                const rect = userMenuButton.getBoundingClientRect();
                userDropdown.style.position = 'fixed';
                userDropdown.style.top = (rect.bottom + 10) + 'px';
                userDropdown.style.right = (window.innerWidth - rect.right) + 'px';
                userDropdown.style.zIndex = '10000';
            }

            // SIMPLE DIRECT ONCLICK HANDLERS - NO BULLSHIT
            console.log('Setting up DIRECT onclick handlers...');
            const menuItems = userDropdown.querySelectorAll('.menu-item');
            console.log('Found menu items:', menuItems.length);

            // Add direct onclick to each button
            menuItems.forEach((item, index) => {
                const action = item.getAttribute('data-action');
                console.log(`Setting up item ${index}: ${action}`);

                item.onclick = function(e) {
                    console.log('DIRECT ONCLICK FIRED FOR:', action);
                    e.preventDefault();
                    e.stopPropagation();

                    // Close dropdown
                    if (userDropdown && document.body.contains(userDropdown)) {
                        document.body.removeChild(userDropdown);
                        userDropdown = null;
                    }

                    // Navigate directly
                    if (action === 'dashboard' || action === 'bookmarks' || action === 'settings') {
                        console.log('CALLING navigateToPage with:', action);
                        navigateToPage(action);
                    } else if (action === 'signout') {
                        handleSignOut();
                    }
                };

                console.log(`Item ${index} onclick set:`, item.onclick);
            });

            document.body.appendChild(userDropdown);
        }

        // Close user menu when clicking outside
        document.addEventListener('click', (event) => {
            const userMenu = document.querySelector('.user-menu');

            // Check if clicking outside the dropdown and user menu
            if (userDropdown &&
                !userDropdown.contains(event.target) &&
                (!userMenu || !userMenu.contains(event.target))) {
                document.body.removeChild(userDropdown);
                userDropdown = null;
            }
        });

        async function handleSignOut() {
            try {
                const { auth } = await import('./lib/supabase.js');
                await auth.signOut();
                showToast('Signed out successfully');
            } catch (error) {
                console.error('Sign out error:', error);
                showToast('Error signing out', true);
            }
        }

        function navigateTo(page) {
            // Navigate to the specified page
            navigateToPage(page);
        }

        function navigateToPage(pageName) {
            console.log('navigateToPage called with:', pageName);

            // Get the main container that holds everything
            const mainContainer = document.querySelector('.container') || document.body;

            if (pageName === 'main') {
                // Show main app with proper styling
                const mainApp = document.getElementById('mainApp');
                if (mainApp) {
                    mainApp.style.display = 'block';
                    mainApp.style.position = 'static';
                    mainApp.style.zIndex = 'auto';
                }

                // Hide other pages completely
                ['dashboardPage', 'bookmarksPage', 'settingsPage'].forEach(pageId => {
                    const page = document.getElementById(pageId);
                    if (page) {
                        page.style.display = 'none';
                        page.style.position = 'static';
                        page.style.zIndex = 'auto';
                    }
                });

                // Scroll to top
                window.scrollTo(0, 0);
            } else {
                // Hide main app completely
                const mainApp = document.getElementById('mainApp');
                if (mainApp) {
                    mainApp.style.display = 'none';
                    console.log('Hiding main app');
                }

                // Hide all other pages first
                ['dashboardPage', 'bookmarksPage', 'settingsPage'].forEach(pageId => {
                    const page = document.getElementById(pageId);
                    if (page) page.style.display = 'none';
                });

                // Show target page
                const targetPage = pageName + 'Page';
                const pageElement = document.getElementById(targetPage);

                if (pageElement) {
                    // Full-screen overlay with solid background
                    pageElement.style.display = 'block';
                    pageElement.style.position = 'fixed';
                    pageElement.style.top = '0';
                    pageElement.style.left = '0';
                    pageElement.style.width = '100vw';
                    pageElement.style.height = '100vh';
                    pageElement.style.zIndex = '1000';
                    pageElement.style.visibility = 'visible';
                    pageElement.style.opacity = '1';
                    pageElement.style.backgroundColor = '#0a0a0f'; // Solid dark background
                    pageElement.style.color = 'var(--primary-text)';
                    pageElement.style.overflow = 'auto';
                    pageElement.style.padding = '20px';
                    pageElement.style.margin = '0';

                    console.log('Full-screen overlay applied to:', targetPage);

                    // Load page-specific data
                    if (pageName === 'dashboard') {
                        loadDashboardData();
                    } else if (pageName === 'bookmarks') {
                        loadBookmarksData();
                    } else if (pageName === 'settings') {
                        loadSettingsData();
                    }

                    // Force scroll to top
                    window.scrollTo(0, 0);

                    console.log('Navigation completed for:', pageName);
                } else {
                    console.error('Page element not found:', targetPage);
                }
            }
        }

        // Dashboard functions
        async function loadDashboardData() {
            try {
                // Load user analytics
                if (currentUser) {
                    const { db } = await import('./lib/supabase.js');

                    // Get user analyses
                    const { data: analyses, error: analysesError } = await db.getUserAnalyses(currentUser.id, 100);
                    if (!analysesError && analyses) {
                        // Update KPIs
                        document.getElementById('totalAnalyses').textContent = analyses.length;

                        const avgScore = analyses.length > 0
                            ? Math.round(analyses.reduce((sum, a) => sum + (a.overall_score || 0), 0) / analyses.length)
                            : '--';
                        document.getElementById('avgQualityScore').textContent = avgScore;

                        const lastAnalysis = analyses[0];
                        if (lastAnalysis) {
                            const daysSince = Math.floor((Date.now() - new Date(lastAnalysis.created_at).getTime()) / (1000 * 60 * 60 * 24));
                            document.getElementById('daysSinceLastAnalysis').textContent = daysSince;
                        }

                        // Load activity feed
                        loadActivityFeed(analyses.slice(0, 10));
                    }

                    // Get bookmarks count
                    const { data: bookmarks, error: bookmarksError } = await db.getUserBookmarks(currentUser.id);
                    if (!bookmarksError && bookmarks) {
                        document.getElementById('totalBookmarks').textContent = bookmarks.length;
                    }
                } else {
                    // Use localStorage data for non-authenticated users
                    const localHistory = JSON.parse(localStorage.getItem('analysisHistory') || '[]');
                    const localBookmarks = JSON.parse(localStorage.getItem('bookmarkedPapers') || '[]');

                    document.getElementById('totalAnalyses').textContent = localHistory.length;
                    document.getElementById('totalBookmarks').textContent = localBookmarks.length;

                    if (localHistory.length > 0) {
                        const avgScore = Math.round(localHistory.reduce((sum, a) => sum + (a.overallScore || 0), 0) / localHistory.length);
                        document.getElementById('avgQualityScore').textContent = avgScore;

                        const lastAnalysis = localHistory[0];
                        if (lastAnalysis?.timestamp) {
                            const daysSince = Math.floor((Date.now() - new Date(lastAnalysis.timestamp).getTime()) / (1000 * 60 * 60 * 24));
                            document.getElementById('daysSinceLastAnalysis').textContent = daysSince;
                        }
                    }
                }

                // Load recommendations
                loadRecommendations();

                // Load topic analysis chart - use appropriate data source
                if (currentUser) {
                    // For authenticated users, we need to get analyses again or pass it properly
                    const analysisData = JSON.parse(localStorage.getItem('analysisHistory') || '[]'); // Fallback
                    loadTopicsChart(analysisData);
                } else {
                    loadTopicsChart(localHistory);
                }

            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showToast('Error loading dashboard data', true);
            }
        }

        function loadActivityFeed(analyses) {
            const activityFeed = document.getElementById('activityFeed');

            if (!analyses || analyses.length === 0) {
                activityFeed.innerHTML = '<div class="loading-placeholder">No recent activity</div>';
                return;
            }

            const activityHtml = analyses.map(analysis => {
                const date = new Date(analysis.created_at || analysis.timestamp).toLocaleDateString();
                const score = analysis.overall_score || analysis.overallScore || 0;
                const title = analysis.title || 'Research Paper';

                return `
                    <div class="activity-item">
                        <div class="activity-icon">📊</div>
                        <div class="activity-content">
                            <div class="activity-title">${title}</div>
                            <div class="activity-meta">Score: ${score}/100 • ${date}</div>
                        </div>
                    </div>
                `;
            }).join('');

            activityFeed.innerHTML = activityHtml;
        }

        function loadRecommendations() {
            // This could be enhanced with AI-generated recommendations based on user's analysis history
            const recommendations = [
                {
                    icon: '📚',
                    title: 'Explore New Domains',
                    description: 'Try analyzing papers from different research domains to broaden your perspective.'
                },
                {
                    icon: '🔖',
                    title: 'Review Your Bookmarks',
                    description: 'Revisit your bookmarked papers and see if there are new connections to discover.'
                },
                {
                    icon: '📈',
                    title: 'Track Quality Trends',
                    description: 'Monitor how the quality scores of papers in your field are changing over time.'
                }
            ];

            const recommendationsHtml = recommendations.map(rec => `
                <div class="recommendation-card">
                    <div class="rec-icon">${rec.icon}</div>
                    <div class="rec-content">
                        <h4>${rec.title}</h4>
                        <p>${rec.description}</p>
                    </div>
                </div>
            `).join('');

            document.getElementById('recommendationsList').innerHTML = recommendationsHtml;
        }

        function loadTopicsChart(analyses) {
            const chartElement = document.getElementById('topicsChart');
            const legendElement = document.getElementById('chartLegend');

            if (!analyses || analyses.length === 0) {
                chartElement.innerHTML = '<div class="loading-placeholder">No analysis data available</div>';
                chartElement.classList.add('empty');
                chartElement.style.background = '#333';
                legendElement.innerHTML = '<div class="loading-placeholder">Analyze some papers to see topic breakdown</div>';
                return;
            }

            // Extract topics from analysis titles and structured data
            const topicCounts = {};

            analyses.forEach(analysis => {
                const title = (analysis.title || '').toLowerCase();
                const content = JSON.stringify(analysis.structured_data || analysis.structuredData || {}).toLowerCase();

                // Define topic keywords
                const topicKeywords = {
                    'Machine Learning': ['machine learning', 'ml', 'neural', 'deep learning', 'ai', 'artificial intelligence', 'algorithm', 'model', 'training'],
                    'Education': ['education', 'teaching', 'learning', 'student', 'curriculum', 'pedagogy', 'academic', 'school', 'university'],
                    'Cryptography': ['cryptography', 'encryption', 'crypto', 'security', 'hash', 'blockchain', 'cipher', 'key', 'protocol'],
                    'Medicine': ['medical', 'medicine', 'health', 'clinical', 'patient', 'treatment', 'disease', 'therapy', 'drug'],
                    'Computer Science': ['computer', 'software', 'programming', 'system', 'network', 'database', 'algorithm', 'computing'],
                    'Physics': ['physics', 'quantum', 'particle', 'energy', 'matter', 'theory', 'experiment', 'relativity'],
                    'Biology': ['biology', 'biological', 'cell', 'gene', 'protein', 'organism', 'evolution', 'dna', 'molecular'],
                    'Other': []
                };

                let matched = false;
                for (const [topic, keywords] of Object.entries(topicKeywords)) {
                    if (topic === 'Other') continue;

                    const hasKeyword = keywords.some(keyword =>
                        title.includes(keyword) || content.includes(keyword)
                    );

                    if (hasKeyword) {
                        topicCounts[topic] = (topicCounts[topic] || 0) + 1;
                        matched = true;
                        break;
                    }
                }

                if (!matched) {
                    topicCounts['Other'] = (topicCounts['Other'] || 0) + 1;
                }
            });

            // Calculate percentages and create chart data
            const total = analyses.length;
            const topics = Object.entries(topicCounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 4); // Top 4 categories

            if (topics.length === 0) {
                chartElement.innerHTML = '<div class="loading-placeholder">No topic data available</div>';
                return;
            }

            const colors = ['#00ff88', '#ff6b6b', '#4ecdc4', '#45b7d1'];

            // Create dynamic conic-gradient based on data
            let gradientParts = [];
            let currentDegree = 0;

            topics.forEach(([topic, count], index) => {
                const degrees = (count / total) * 360;
                const color = colors[index] || colors[colors.length - 1];

                gradientParts.push(`${color} ${currentDegree}deg ${currentDegree + degrees}deg`);
                currentDegree += degrees;
            });

            // Apply the gradient to the chart
            const gradient = `conic-gradient(from 0deg, ${gradientParts.join(', ')})`;
            chartElement.style.background = gradient;
            chartElement.classList.remove('empty');

            // Create legend
            const legendHtml = topics.map(([topic, count], index) => {
                const percentage = Math.round((count / total) * 100);
                return `
                    <div class="legend-item">
                        <div class="legend-color" style="background: ${colors[index]}"></div>
                        <div class="legend-text">
                            <span class="legend-label">${topic}</span>
                            <span class="legend-percentage">${percentage}%</span>
                        </div>
                    </div>
                `;
            }).join('');

            legendElement.innerHTML = legendHtml;
            chartElement.innerHTML = ''; // Clear loading message
        }

        // Bookmarks functions
        async function loadBookmarksData() {
            const bookmarksGrid = document.getElementById('bookmarksGrid');
            bookmarksGrid.innerHTML = '<div class="loading-placeholder">Loading bookmarks...</div>';

            try {
                let bookmarks = [];

                if (currentUser) {
                    // Load from Supabase
                    const { db } = await import('./lib/supabase.js');
                    const { data, error } = await db.getUserBookmarks(currentUser.id);
                    if (!error && data) {
                        bookmarks = data.map(bookmark => ({
                            id: bookmark.id,
                            title: bookmark.title,
                            url: bookmark.url,
                            score: bookmark.overall_score,
                            date: new Date(bookmark.created_at).toLocaleDateString()
                        }));
                    }
                } else {
                    // Load from localStorage
                    const localBookmarks = JSON.parse(localStorage.getItem('bookmarkedPapers') || '[]');
                    bookmarks = localBookmarks.map(bookmark => ({
                        id: bookmark.id,
                        title: bookmark.title,
                        url: bookmark.url,
                        score: bookmark.overallScore,
                        date: new Date(bookmark.timestamp).toLocaleDateString(),
                        categories: bookmark.categories || ['Other'], // Backward compatibility
                        tags: bookmark.tags || []
                    }));
                }

                if (bookmarks.length === 0) {
                    bookmarksGrid.innerHTML = '<div class="loading-placeholder">No bookmarks yet. Start by bookmarking some papers!</div>';
                    return;
                }

                displayBookmarks(bookmarks);

            } catch (error) {
                console.error('Error loading bookmarks:', error);
                bookmarksGrid.innerHTML = '<div class="loading-placeholder">Error loading bookmarks</div>';
            }
        }

        function displayBookmarks(bookmarks) {
            const bookmarksGrid = document.getElementById('bookmarksGrid');

            const bookmarksHtml = bookmarks.map(bookmark => `
                <div class="bookmark-card" data-bookmark-id="${bookmark.id}">
                    <input type="checkbox" class="bookmark-checkbox" value="${bookmark.id}">
                    <div class="bookmark-score">${bookmark.score || 0}</div>
                    <div class="bookmark-title">${bookmark.title}</div>
                    <div class="bookmark-url">${bookmark.url}</div>
                    <div class="bookmark-date">${bookmark.date}</div>
                    ${bookmark.categories ? `
                        <div class="bookmark-categories">
                            ${bookmark.categories.map(cat => `<span class="category-tag">${cat}</span>`).join('')}
                        </div>
                    ` : ''}
                    ${bookmark.tags && bookmark.tags.length > 0 ? `
                        <div class="bookmark-tags">
                            ${bookmark.tags.map(tag => `<span class="bookmark-tag">${tag}</span>`).join('')}
                        </div>
                    ` : ''}
                </div>
            `).join('');

            bookmarksGrid.innerHTML = bookmarksHtml;

            // Add click handlers
            bookmarksGrid.querySelectorAll('.bookmark-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    if (e.target.type !== 'checkbox') {
                        const url = card.querySelector('.bookmark-url').textContent;
                        // Navigate back to main page and load the analysis
                        navigateToPage('main');
                        document.getElementById('urlInput').value = url;
                        analyzeCase();
                    }
                });

                const checkbox = card.querySelector('.bookmark-checkbox');
                checkbox.addEventListener('change', () => {
                    card.classList.toggle('selected', checkbox.checked);
                });
            });
        }

        // Settings functions
        function loadSettingsData() {
            if (currentUser) {
                // Load user profile data
                document.getElementById('profileEmail').value = currentUser.email || '';
                document.getElementById('profileName').value = currentUser.user_metadata?.name || '';
            }

            // Load saved preferences from localStorage
            const preferences = JSON.parse(localStorage.getItem('userPreferences') || '{}');

            const analysisDepthEl = document.getElementById('analysisDepth');
            const autoSaveEl = document.getElementById('autoSaveAnalyses');
            const showProgressEl = document.getElementById('showProgressDetails');
            const notificationsEl = document.getElementById('analysisNotifications');
            const weeklySummaryEl = document.getElementById('weeklySummary');
            const dataRetentionEl = document.getElementById('dataRetention');

            if (analysisDepthEl) analysisDepthEl.value = preferences.analysisDepth || 'standard';
            if (autoSaveEl) autoSaveEl.checked = preferences.autoSave !== false;
            if (showProgressEl) showProgressEl.checked = preferences.showProgress !== false;
            if (notificationsEl) notificationsEl.checked = preferences.notifications !== false;
            if (weeklySummaryEl) weeklySummaryEl.checked = preferences.weeklySummary === true;
            if (dataRetentionEl) dataRetentionEl.value = preferences.dataRetention || 'forever';

            // Update storage information
            updateStorageInfo();
        }

        function showSettingsSection(sectionName) {
            // Update nav
            document.querySelectorAll('.settings-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.settings-nav-item').classList.add('active');

            // Update content
            document.querySelectorAll('.settings-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionName + 'Settings').classList.add('active');
        }

        function saveProfileSettings() {
            const name = document.getElementById('profileName').value;

            // Save to localStorage for now
            const preferences = JSON.parse(localStorage.getItem('userPreferences') || '{}');
            preferences.profileName = name;
            localStorage.setItem('userPreferences', JSON.stringify(preferences));

            showToast('Profile settings saved!');
        }

        function savePreferences() {
            const preferences = {
                analysisDepth: document.getElementById('analysisDepth').value,
                autoSave: document.getElementById('autoSaveAnalyses').checked,
                showProgress: document.getElementById('showProgressDetails').checked
            };

            localStorage.setItem('userPreferences', JSON.stringify(preferences));
            showToast('Preferences saved!');
        }

        function saveNotificationSettings() {
            const preferences = JSON.parse(localStorage.getItem('userPreferences') || '{}');
            preferences.notifications = document.getElementById('analysisNotifications').checked;
            preferences.weeklySummary = document.getElementById('weeklySummary').checked;

            localStorage.setItem('userPreferences', JSON.stringify(preferences));
            showToast('Notification settings saved!');
        }

        function confirmClearAllData() {
            if (confirm('Are you sure you want to clear all your data? This will remove all analyses, bookmarks, and preferences. This action cannot be undone.')) {
                clearAllData();
            }
        }

        function clearAllData() {
            try {
                localStorage.removeItem('analysisHistory');
                localStorage.removeItem('bookmarkedPapers');
                localStorage.removeItem('userPreferences');

                // Update storage display
                updateStorageInfo();

                showToast('All data cleared successfully');

                // Refresh current page if on dashboard or bookmarks
                const currentPage = document.querySelector('.app-page[style*="display: block"]');
                if (currentPage) {
                    const pageId = currentPage.id;
                    if (pageId === 'dashboardPage') {
                        loadDashboardData();
                    } else if (pageId === 'bookmarksPage') {
                        loadBookmarksData();
                    }
                }
            } catch (error) {
                console.error('Error clearing data:', error);
                showToast('Error clearing data', true);
            }
        }

        function confirmDeleteAccount() {
            if (confirm('Are you sure you want to delete your account? This will remove all your data and cannot be undone.')) {
                deleteAccount();
            }
        }

        function deleteAccount() {
            // For now, just clear local data and show message
            // In a real app, this would call the backend to delete the account
            clearAllData();

            if (currentUser) {
                showToast('Account deletion initiated. You will be signed out.');
                setTimeout(async () => {
                    try {
                        const { auth } = await import('./lib/supabase.js');
                        await auth.signOut();
                        navigateToPage('main');
                    } catch (error) {
                        console.error('Sign out error:', error);
                        navigateToPage('main');
                    }
                }, 2000);
            } else {
                showToast('All local data cleared');
                navigateToPage('main');
            }
        }

        function updateStorageInfo() {
            try {
                const analyses = localStorage.getItem('analysisHistory') || '[]';
                const bookmarks = localStorage.getItem('bookmarkedPapers') || '[]';
                const preferences = localStorage.getItem('userPreferences') || '{}';

                const totalBytes = new Blob([analyses, bookmarks, preferences]).size;
                const totalMB = (totalBytes / (1024 * 1024)).toFixed(2);

                // Assume 10MB limit for display purposes
                const maxMB = 10;
                const percentage = Math.min((totalMB / maxMB) * 100, 100);

                const storageBar = document.getElementById('storageUsage');
                const storageText = document.getElementById('storageText');

                if (storageBar && storageText) {
                    storageBar.style.width = `${percentage}%`;
                    storageText.textContent = `Used ${totalMB} MB of ${maxMB} MB available`;

                    // Change color based on usage
                    if (percentage > 80) {
                        storageBar.style.backgroundColor = '#ff6b6b';
                    } else if (percentage > 60) {
                        storageBar.style.backgroundColor = '#ffa726';
                    } else {
                        storageBar.style.backgroundColor = '#00ff88';
                    }
                }
            } catch (error) {
                console.error('Error updating storage info:', error);
            }
        }

        // Utility functions for bookmarks and dashboard
        function filterBookmarks() {
            const searchTerm = document.getElementById('bookmarkSearch').value.toLowerCase();
            const cards = document.querySelectorAll('.bookmark-card');

            cards.forEach(card => {
                const title = card.querySelector('.bookmark-title').textContent.toLowerCase();
                const url = card.querySelector('.bookmark-url').textContent.toLowerCase();

                // Also search in categories and tags
                const categories = card.querySelector('.bookmark-categories');
                const tags = card.querySelector('.bookmark-tags');

                const categoryText = categories ? categories.textContent.toLowerCase() : '';
                const tagText = tags ? tags.textContent.toLowerCase() : '';

                const matches = title.includes(searchTerm) ||
                              url.includes(searchTerm) ||
                              categoryText.includes(searchTerm) ||
                              tagText.includes(searchTerm);

                card.style.display = matches ? 'block' : 'none';
            });
        }

        function sortBookmarks() {
            const sortBy = document.getElementById('bookmarkSort').value;
            const bookmarksGrid = document.getElementById('bookmarksGrid');
            const cards = Array.from(bookmarksGrid.querySelectorAll('.bookmark-card'));

            cards.sort((a, b) => {
                switch(sortBy) {
                    case 'date-newest':
                        return new Date(b.querySelector('.bookmark-date').textContent) -
                               new Date(a.querySelector('.bookmark-date').textContent);
                    case 'date-oldest':
                        return new Date(a.querySelector('.bookmark-date').textContent) -
                               new Date(b.querySelector('.bookmark-date').textContent);
                    case 'score-high':
                        return parseInt(b.querySelector('.bookmark-score').textContent) -
                               parseInt(a.querySelector('.bookmark-score').textContent);
                    case 'score-low':
                        return parseInt(a.querySelector('.bookmark-score').textContent) -
                               parseInt(b.querySelector('.bookmark-score').textContent);
                    case 'title-az':
                        return a.querySelector('.bookmark-title').textContent.localeCompare(
                               b.querySelector('.bookmark-title').textContent);
                    case 'title-za':
                        return b.querySelector('.bookmark-title').textContent.localeCompare(
                               a.querySelector('.bookmark-title').textContent);
                    default:
                        return 0;
                }
            });

            // Re-append cards in sorted order
            cards.forEach(card => bookmarksGrid.appendChild(card));

            showToast(`Bookmarks sorted by ${sortBy.replace('-', ' ')}`);
        }

        function clearBookmarkFilters() {
            // Clear search input
            const searchInput = document.getElementById('bookmarkSearch');
            if (searchInput) {
                searchInput.value = '';
            }

            // Reset sort to default
            const sortSelect = document.getElementById('bookmarkSort');
            if (sortSelect) {
                sortSelect.value = 'date-newest';
            }

            // Show all cards
            const cards = document.querySelectorAll('.bookmark-card');
            cards.forEach(card => {
                card.style.display = 'block';
            });

            // Re-sort to default
            sortBookmarks();

            showToast('Filters cleared');
        }

        function selectAllBookmarks() {
            const checkboxes = document.querySelectorAll('.bookmark-checkbox');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);

            checkboxes.forEach(cb => {
                cb.checked = !allChecked;
                cb.closest('.bookmark-card').classList.toggle('selected', cb.checked);
            });
        }

        function exportSelectedBookmarks() {
            const selectedIds = Array.from(document.querySelectorAll('.bookmark-checkbox:checked')).map(cb => cb.value);
            if (selectedIds.length === 0) {
                showToast('Please select bookmarks to export', true);
                return;
            }

            // Get selected bookmark data
            const selectedBookmarks = [];
            selectedIds.forEach(id => {
                const card = document.querySelector(`[data-bookmark-id="${id}"]`);
                if (card) {
                    selectedBookmarks.push({
                        title: card.querySelector('.bookmark-title').textContent,
                        url: card.querySelector('.bookmark-url').textContent,
                        score: card.querySelector('.bookmark-score').textContent,
                        date: card.querySelector('.bookmark-date').textContent
                    });
                }
            });

            // Create and download CSV
            const csv = convertToCSV(selectedBookmarks, ['title', 'url', 'score', 'date']);
            downloadFile(csv, `bookmarks_${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
            showToast(`Exported ${selectedIds.length} bookmarks successfully!`);
        }

        function exportAllUserData() {
            try {
                const userData = {
                    bookmarks: JSON.parse(localStorage.getItem('bookmarkedPapers') || '[]'),
                    analyses: JSON.parse(localStorage.getItem('analysisHistory') || '[]'),
                    preferences: JSON.parse(localStorage.getItem('userPreferences') || '{}'),
                    exportDate: new Date().toISOString()
                };

                const jsonStr = JSON.stringify(userData, null, 2);
                downloadFile(jsonStr, `user_data_backup_${new Date().toISOString().split('T')[0]}.json`, 'application/json');
                showToast('User data exported successfully!');
            } catch (error) {
                console.error('Export error:', error);
                showToast('Error exporting user data', true);
            }
        }

        function exportAllAnalyses() {
            try {
                const analyses = JSON.parse(localStorage.getItem('analysisHistory') || '[]');
                if (analyses.length === 0) {
                    showToast('No analyses to export', true);
                    return;
                }

                const csv = convertToCSV(analyses, ['title', 'url', 'overallScore', 'timestamp']);
                downloadFile(csv, `analyses_${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
                showToast(`Exported ${analyses.length} analyses successfully!`);
            } catch (error) {
                console.error('Export error:', error);
                showToast('Error exporting analyses', true);
            }
        }

        // Utility functions for export
        function convertToCSV(data, headers) {
            if (!data || data.length === 0) return '';

            const csvHeaders = headers.join(',');
            const csvRows = data.map(row =>
                headers.map(header => {
                    const value = row[header] || '';
                    return `"${String(value).replace(/"/g, '""')}"`;
                }).join(',')
            );

            return [csvHeaders, ...csvRows].join('\n');
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

    </script>
</body>
</html>

